<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotbollscup Schema</title>
    <!-- Tailwind CSS CDN för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Ljusgrå bakgrund */
            min-height: 100vh;
            /* Säkerställer att bakgrunden täcker hela sidan */
            display: flex;
            flex-direction: column;
            /* För att navbaren ska ligga överst */
            align-items: center;
            justify-content: flex-start;
            /* Justera för navbar */
            padding: 0;
            /* Ta bort padding från body */
        }

        .navbar {
            width: 100%;
            background-color: #1a202c;
            /* Mörk bakgrund för navbar */
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            /* Kvar på toppen vid scroll */
            top: 0;
            z-index: 1000;
            /* Säkerställ att den ligger över annat innehåll */
            display: flex;
            /* Använd flexbox */
            align-items: center;
            /* Centrera vertikalt */
            justify-content: flex-start;
            /* Starta objekt från vänster */
            flex-wrap: wrap;
            /* Tillåt objekt att bryta rad om utrymmet är begränsat */
        }

        .navbar-home-logo {
            height: 2.5rem;
            /* Storlek på logotypen som hemknapp */
            margin-right: 1.5rem;
            /* Mer utrymme till höger om logotypen */
            cursor: pointer;
            border-radius: 9999px;
            /* Rundad */
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
            /* Förhindra att logotypen krymper */
        }

        .navbar-home-logo:hover {
            transform: scale(1.05);
            /* Lätt förstoring vid hover */
        }

        .navbar-links-wrapper {
            display: flex;
            flex-wrap: wrap;
            /* Tillåt länkar att bryta rad */
            gap: 0.5rem;
            /* Litet mellanrum mellan länkar */
            flex-grow: 1;
            /* Tillåt länkomslutningen att ta tillgängligt utrymme */
            justify-content: center;
            /* Centrera länkar inom deras omslutning på små skärmar om de bryter rad */
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            /* Något minskad padding för kompakthet */
            border-radius: 0.375rem;
            /* rounded-md */
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            white-space: nowrap;
            /* Förhindra att länkar bryter text */
        }

        .navbar a:hover {
            background-color: #4a5568;
            /* Mörkare grå vid hover */
        }

        .content-container {
            max-width: 960px;
            /* max-w-4xl är ca 960px */
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            /* Justerad padding */
            margin-top: 2rem;
            /* Marginal från navbar */
            margin-bottom: 2rem;
            flex-grow: 1;
            /* Låter innehållskontainern växa och pressa ner footern */
        }

        /* Anpassade stilar för matchraderna */
        .game-row {
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-lg */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            /* Subtil skugga */
            padding: 1.5rem;
            /* Ökat padding för luftigare känsla */
            margin-bottom: 1rem;
            /* Avstånd mellan rader */
            display: flex;
            flex-direction: column;
            /* För liten skärm */
            align-items: flex-start;
            transition: transform 0.2s ease-in-out;
        }

        .game-row:hover {
            transform: translateY(-3px);
            /* Subtil lyft vid hover */
        }

        @media (min-width: 768px) {

            /* För större skärmar (md) */
            .game-row {
                flex-direction: row;
                /* En rad */
                align-items: center;
                /* Centrera vertikalt */
                justify-content: space-between;
                /* Sprid ut innehållet */
            }
        }

        .team-display {
            display: flex;
            align-items: center;
            font-weight: 600;
            /* semi-bold */
        }

        .team-logo {
            width: 3rem;
            /* 48px */
            height: 3rem;
            /* 48px */
            border-radius: 9999px;
            /* circular */
            object-fit: cover;
            margin-right: 0.75rem;
            /* Avstånd från teamnamn */
            flex-shrink: 0;
            /* Förhindra att logotypen krymper */
        }

        .highlighted-game {
            border: 2px solid #3b82f6;
            /* Blå kantlinje för markerade spel */
            background-color: #eff6ff;
            /* Ljusare blå bakgrund */
        }

        .highlighted-team-text {
            /* För att markera texten för laget */
            color: #1d4ed8;
            /* Mörkare blå text */
        }

        .game-details {
            display: flex;
            flex-direction: column;
            text-align: left;
            /* Standard för detaljer */
            margin-top: 1rem;
            /* Avstånd för små skärmar */
            width: 100%;
            /* Full bredd för små skärmar */
        }

        @media (min-width: 768px) {
            .game-details {
                margin-top: 0;
                /* Ingen marginal för större skärmar */
                width: auto;
                /* Låt innehållet bestämma bredden */
                text-align: right;
                /* Högerjustera detaljer */
            }
        }

        .game-time-venue {
            font-size: 1.125rem;
            /* text-lg */
            font-weight: 600;
            /* semi-bold */
            color: #4a5568;
            /* grå text */
        }

        .game-group-note {
            font-size: 0.875rem;
            /* text-sm */
            color: #6b7280;
            /* mörkare grå */
        }

        .game-result {
            font-size: 1.25rem;
            /* text-xl */
            font-weight: 700;
            /* font-bold */
            color: #2d3748;
            /* dark grey text */
            margin-top: 0.5rem;
        }

        /* Footer styling */
        .footer {
            width: 100%;
            background-color: #1a202c;
            /* Mörk bakgrund för footer */
            padding: 1.5rem;
            text-align: center;
            margin-top: auto;
            /* Trycker ner footern till botten */
        }

        .footer-logo {
            max-width: 100%;
            /* Anpassa till skärmbredden */
            height: 6rem;
            /* FAST HÖJD FÖR FOTLOGOTYPEN, ÖKAD FRÅN 4REM TILL 6REM */
            object-fit: contain;
            /* Behåll proportioner, se till att hela bilden syns */
            display: block;
            /* Centrera bilden */
            margin: 0 auto;
            /* Centrera bilden horisontellt */
        }

        @media (max-width: 640px) {

            /* För mobil (sm breakpoint) */
            .navbar {
                flex-direction: column;
                /* Stapla logotyp och länkar vertikalt */
                align-items: center;
                /* Centrera allt */
            }

            .navbar-home-logo {
                margin-right: 0;
                /* Ingen marginal till höger om logotypen om den är centrerad */
                margin-bottom: 1rem;
                /* Avstånd till länkarna nedanför */
            }

            .navbar-links-wrapper {
                width: 100%;
                /* Ta full bredd under logotypen */
                justify-content: center;
                /* Centrera länkar i en rad som bryter */
            }

            .navbar a {
                width: auto;
                /* Låt länkarna bestämma sin egen bredd */
            }
        }
    </style>
</head>

<body class="flex flex-col">
    <!-- Global Navigationsmeny -->
    <nav class="navbar">
        <a href="index.html">
            <img src="https://i.imgur.com/pwnWIDU.png" alt="Arboga Stad SK Logo" class="navbar-home-logo">
        </a>
        <div class="navbar-links-wrapper">
            <a href="index.html">Startsida</a>
            <a href="fotbollsschema.html">Spelschema</a>
            <a href="lagregister.html">Lagregister</a>
            <a href="spelaregister.html">Spelarregister</a>
            <a href="tabeller.html">Tabeller</a>
            <a href="sponsorer.html">Samarbetspartners</a>
            <a href="aktiviteter.html">Aktiviteter</a>
            <a href="efterfesten.html">Efterfesten</a>
        </div>
    </nav>

    <div class="content-container">
        <!-- Rubriksektion -->
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Fotbollscup Schema</h1>
            <p class="text-lg text-gray-600">Hitta dina matcher snabbt och enkelt.</p>
        </header>

        <!-- Kontrollsektion -->
        <div class="flex flex-col sm:flex-row items-center justify-between mb-8 space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="w-full sm:w-1/2">
                <label for="team-select" class="block text-gray-700 text-sm font-medium mb-2">Välj ditt lag:</label>
                <select id="team-select"
                    class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-800 appearance-none bg-white">
                    <option value="All Teams">Alla lag</option>
                    <!-- Lag kommer att fyllas i här av JavaScript -->
                </select>
            </div>
            <div class="flex space-x-3 w-full sm:w-auto">
                <button id="view-all-btn"
                    class="flex-1 px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200">
                    Visa alla matcher
                </button>
                <button id="my-games-btn"
                    class="flex-1 px-5 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200">
                    Mina matcher
                </button>
            </div>
        </div>

        <!-- Informations-/instruktionsmeddelande -->
        <p id="info-message" class="text-center text-gray-600 mb-8 p-3 bg-blue-50 rounded-lg border border-blue-200">
            Visar alla schemalagda matcher. Välj ditt lag för att markera dina matcher.
        </p>

        <!-- Spelschema sektion -->
        <div id="game-list" class="flex flex-col gap-4">
            <!-- Spelkorten kommer att renderas här av JavaScript -->
            <div class="text-center text-gray-500 p-8">Laddar schema...</div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer class="footer">
        <img src="https://i.imgur.com/9q8c3ab.png" alt="Cup Footer Logo" class="footer-logo">
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed for fotbollsschema.html');

            // !!! VIKTIGT !!!
            // Denna URL pekar nu på din dedikerade PUB_GROUP_SCHEDULE Google Sheet.
            // Se till att din Google Sheet är publicerad som "Comma-separated values (.csv)".
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=894699500&single=true&output=csv';

            // !!! VIKTIGT FÖR LOGOTYPER !!!
            // Denna URL pekar nu på din dedikerade PUB_TEAMINFO Google Sheet.
            // Se till att din Google Sheet är publicerad som "Comma-separated values (.csv)".
            // Se också till att 'Logo'-kolumnen i lagregistret innehåller DIREKTA BILD-URL:er (t.ex. https://example.com/logo.png), inte länkar till Google Drive-visningslänkar.
            const teamsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=213368947&single=true&output=csv';

            const teamSelect = document.getElementById('team-select');
            const viewAllBtn = document.getElementById('view-all-btn');
            const myGamesBtn = document.getElementById('my-games-btn');
            const gameListDiv = document.getElementById('game-list');
            const infoMessage = document.getElementById('info-message');

            let allGames = []; // Lagrar rådata från spelschema CSV
            let allTeamsData = []; // Lagrar rådata från lagregister CSV för logotyper
            let currentFilterTeam = 'All Teams';
            let showMyGamesOnly = false;

            /**
             * Hämtar CSV-data från den angivna URL:en.
             * @param {string} url URL:en till CSV-filen.
             * @returns {Promise<string>} Ett löfte som löser med CSV-texten.
             */
            async function fetchCsvData(url) {
                console.log(`Attempting to fetch CSV from: ${url}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorMsg = `HTTP Error! status: ${response.status} fetching ${url}`;
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }
                    console.log(`Successfully fetched CSV from: ${url}`);
                    return await response.text();
                } catch (error) {
                    console.error(`Error fetching CSV data from: ${url}`, error);
                    // Denna felmeddelandedel hanteras i initializeSchedule för att vara mer specifik
                    throw error; // Propagera felet uppåt
                }
            }

            /**
             * En robust CSV-parserfunktion som hanterar fält med kommatecken och citationstecken.
             * Förutsätter att fält som innehåller kommatecken är omslutna av dubbla citationstecken.
             * Hanterar även dubbla citationstecken inom citerade fält (genom att fördubbla dem, t.ex. "He said ""Hello""").
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Array<string>>} En array av rader, där varje rad är en array av strängvärden.
             */
            function parseRobustCsv(csvText) {
                const rows = [];
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) { // Tom CSV eller bara whitespace-rader
                    return [];
                }

                // Bearbeta dataraderna (hoppa över rubrikraden för intern parsning)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const values = [];
                    let inQuote = false;
                    let currentField = '';

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const nextChar = line[j + 1];

                        if (char === '"') {
                            if (inQuote && nextChar === '"') { // Hantera dubbla citationstecken inuti ett citerat fält ("" blir ")
                                currentField += char;
                                j++; // Hoppa över nästa citationstecken
                            } else {
                                inQuote = !inQuote; // Växla in/ut ur citerat läge
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField.trim()); // Lägg till det sista fältet på raden
                    rows.push(values);
                }
                console.log(`Parsed ${rows.length - 1} data rows.`); // Log how many data rows were parsed
                return rows.slice(1); // Returnera alla rader utom rubrikraden
            }

            /**
             * Parsar den robusta CSV-texten till en array av spelobjekt från PUB_GROUP_SCHEDULE.
             * VIKTIGT: Denna funktion förväntar sig att kolumnerna är i DENNA SPECIFIKA ORDNING:
             * Matchid|Time|Hemma|Borta|Plansponsor|Group|Resultat|Anmärkning
             * Om kolumnordningen i ditt Google Sheet är annorlunda, MÅSTE du justera indexen nedan.
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Object>} En array av spelobjekt.
             */
            function parseScheduleCsv(csvText) {
                const rawRows = parseRobustCsv(csvText); // Använd den robusta parsern
                if (rawRows.length === 0) {
                    console.warn("Schedule CSV is empty or parsing resulted in no data.");
                    return [];
                }

                const games = [];
                // Kolumnmappning baserad på din angivna ordning: Matchid|Time|Hemma|Borta|Plansponsor|Group|Resultat|Anmärkning
                const headers = ['matchId', 'time', 'team1', 'team2', 'venue', 'group', 'result', 'note'];

                rawRows.forEach((values, index) => {
                    if (values.length >= headers.length) {
                        const game = {
                            matchId: values[0] ? values[0].trim() : 'N/A',
                            time: values[1] ? values[1].trim() : 'N/A',
                            team1: values[2] ? values[2].trim() : 'N/A',
                            team2: values[3] ? values[3].trim() : 'N/A',
                            venue: values[4] ? values[4].trim() : 'N/A',
                            group: values[5] ? values[5].trim() : 'N/A',
                            result: values[6] ? values[6].trim() : 'N/A', // Ny kolumn
                            note: values[7] ? values[7].trim() : 'N/A',
                            date: 'N/A' // Date column is not present in the new schema, setting to N/A
                        };
                        games.push(game);
                    } else {
                        console.warn(`Hoppar över felaktig schemarad ${index + 2}: Inte tillräckligt med kolumner (förväntade ${headers.length}, hittade ${values.length}). Radinnehåll: "${values.join(',')}"`); // index + 2 för att matcha radnummer i Google Sheet
                    }
                });
                return games;
            }

            /**
             * Parsar CSV-text till en array av lagobjekt. Används för att hämta logotyper.
             * VIKTIGT: Denna funktion förväntar sig kolumnerna i DENNA SPECIFIKA ORDNING:
             * Lagnamn|Logo|Lagkapten|Samarbetspartner|Grupp|Spelare (K=Kapten, MV=Keeper)|TEAM_DESCRIPTION|TEAM_STYLE|SECRET_WEAPON|HIGHLIGHT_OPS|GROUP_THREAT|TEAM_EXP|CELEBRATION|MOTTO|BetStats
             * Om kolumnordningen i ditt Google Sheet är annorlunda, MÅSTE du justera indexen nedan.
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Object>} En array av lagobjekt.
             */
            function parseTeamsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) {
                    console.warn("Teams CSV is empty or parsing resulted in no data.");
                    return [];
                }

                const teams = [];
                // Kolumnmappning baserad på din angivna ordning
                const headers = [
                    'teamName', 'logo', 'captainName', 'sponsor', 'group', 'playersRaw',
                    'teamDescription', 'teamStyle', 'secretWeapon', 'highlightOps',
                    'groupThreat', 'teamExp', 'celebration', 'motto', 'betStats'
                ];

                rawRows.forEach((values, index) => {
                    if (values.length >= 15) {
                        const team = {
                            teamName: values[0] ? values[0].trim() : 'N/A',
                            logo: values[1] ? values[1].trim() : 'https://placehold.co/100x100/aabbcc/ffffff?text=Team+Logo', // Platshållarbild om ingen URL finns
                            captainName: values[2] ? values[2].trim() : 'N/A',
                            sponsor: values[3] ? values[3].trim() : 'N/A',
                            group: values[4] ? values[4].trim() : 'N/A',
                            playersRaw: values[5] ? values[5].trim() : '',
                            teamDescription: values[6] ? values[6].trim() : 'N/A',
                            teamStyle: values[7] ? values[7].trim() : 'N/A',
                            secretWeapon: values[8] ? values[8].trim() : 'N/A',
                            highlightOps: values[9] ? values[9].trim() : 'N/A',
                            groupThreat: values[10] ? values[10].trim() : 'N/A',
                            teamExp: values[11] ? values[11].trim() : 'N/A',
                            celebration: values[12] ? values[12].trim() : 'N/A',
                            motto: values[13] ? values[13].trim() : 'N/A',
                            betStats: values[14] ? values[14].trim() : 'N/A'
                        };
                        teams.push(team);
                    } else {
                        console.warn(`Hoppar över felaktig lagrad ${index + 2}: Inte tillräckligt med kolumner (förväntade ${headers.length}, hittade ${values.length}).`);
                    }
                });
                return teams;
            }

            /**
             * Hämtar en lags logotyp-URL.
             * @param {string} teamName Namnet på laget.
             * @returns {string} Logotypens URL eller en platshållar-URL.
             */
            function getTeamLogo(teamName) {
                const team = allTeamsData.find(t => t.teamName === teamName);
                // Använder team.logo om den finns, annars den specifika platshållarbilden för logotypfel.
                // Lägg till en fallback för att hantera om team.logo är tom eller ogiltig.
                return (team && team.logo && isValidImageUrl(team.logo)) ? team.logo : 'https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo';
            }

            /**
             * Kontrollerar om en URL ser ut som en giltig bild-URL.
             * @param {string} url
             * @returns {boolean}
             */
            function isValidImageUrl(url) {
                return (url.startsWith('http://') || url.startsWith('https://')) &&
                    (/\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url));
            }


            /**
             * Fyller i lagvalsrullgardinsmenyn med unika lag från speldatan.
             */
            function populateTeamDropdown() {
                const teams = new Set();
                allGames.forEach(game => {
                    if (game.team1 && game.team1 !== 'N/A') teams.add(game.team1);
                    if (game.team2 && game.team2 !== 'N/A') teams.add(game.team2);
                });

                // Rensa befintliga alternativ förutom "Alla lag"
                teamSelect.innerHTML = '<option value="All Teams">Alla lag</option>';

                // Lägg till unika lag, sorterade alfabetiskt
                Array.from(teams).sort().forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamSelect.appendChild(option);
                });
                console.log('Team dropdown populated.');
            }

            /**
             * Renderar spelschemat baserat på aktuella filter.
             */
            function renderSchedule() {
                console.log('renderSchedule called. Clearing game list. Current filter team:', currentFilterTeam, 'Show my games only:', showMyGamesOnly);
                gameListDiv.innerHTML = ''; // Rensa tidigare spel

                let gamesToDisplay = allGames;

                // Använd "Mina matcher" filtret först om det är aktivt och ett lag är valt
                if (showMyGamesOnly && currentFilterTeam !== 'All Teams') {
                    gamesToDisplay = allGames.filter(game =>
                        game.team1 === currentFilterTeam || game.team2 === currentFilterTeam
                    );
                    infoMessage.textContent = `Visar endast matcher för "${currentFilterTeam}".`;
                } else if (!showMyGamesOnly && currentFilterTeam !== 'All Teams') {
                    // Om "Visa alla matcher" är aktivt och ett lag är valt, visa alla men markera
                    infoMessage.textContent = `Visar alla matcher. "${currentFilterTeam}" matcher är markerade.`;
                } else {
                    // Standardläge eller "Visa alla matcher" och "Alla lag" valda
                    infoMessage.textContent = 'Visar alla schemalagda matcher. Välj ditt lag för att markera eller filtrera dina matcher.';
                }

                if (gamesToDisplay.length === 0) {
                    gameListDiv.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Inga matcher hittades som matchar dina kriterier.</div>`;
                    console.warn('No games to display based on current filters.');
                    return;
                }

                gamesToDisplay.forEach(game => {
                    const gameRow = document.createElement('div');
                    // Lägg till highlighted-game-klass om det aktuella filterlaget är en del av spelet OCH det inte är 'Alla lag'
                    const isHighlighted = currentFilterTeam !== 'All Teams' &&
                        (game.team1 === currentFilterTeam || game.team2 === currentFilterTeam);
                    gameRow.className = `game-row ${isHighlighted ? 'highlighted-game' : ''}`;

                    const team1Logo = getTeamLogo(game.team1);
                    const team2Logo = getTeamLogo(game.team2);

                    const team1Class = (currentFilterTeam !== 'All Teams' && game.team1 === currentFilterTeam) ? 'highlighted-team-text' : '';
                    const team2Class = (currentFilterTeam !== 'All Teams' && game.team2 === currentFilterTeam) ? 'highlighted-team-text' : '';

                    gameRow.innerHTML = `
                        <div class="flex flex-col md:flex-row items-center justify-center md:justify-start flex-grow mb-4 md:mb-0 md:w-1/2">
                            <div class="team-display mr-4">
                                <img src="${team1Logo}" alt="${game.team1} Logo" class="team-logo">
                                <span class="${team1Class} text-lg md:text-xl font-bold">${game.team1 || 'N/A'}</span>
                            </div>
                            <span class="text-gray-500 text-base md:text-lg mx-2 md:mx-4 font-semibold">vs</span>
                            <div class="team-display">
                                <img src="${team2Logo}" alt="${game.team2} Logo" class="team-logo">
                                <span class="${team2Class} text-lg md:text-xl font-bold">${game.team2 || 'N/A'}</span>
                            </div>
                        </div>

                        <div class="game-details md:w-1/2">
                            <p class="game-time-venue">
                                ${game.time || 'N/A'} @ ${game.venue || 'N/A'}
                            </p>
                            <!-- Matchresultat visas inte längre på spelschemat -->
                            <p class="game-group-note">
                                Grupp: ${game.group || 'N/A'} ${game.note && game.note !== 'N/A' ? ` | Anm: ${game.note}` : ''}
                            </p>
                        </div>
                    `;
                    gameListDiv.appendChild(gameRow);
                });
                console.log(`Rendered ${gamesToDisplay.length} games.`);
            }

            /**
             * Uppdaterar knapparnas stilar baserat på det aktiva filtret.
             */
            function updateFilterButtons() {
                if (showMyGamesOnly) {
                    myGamesBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    myGamesBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    viewAllBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    viewAllBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                } else {
                    viewAllBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    viewAllBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    myGamesBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    myGamesBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                }
                console.log('Filter buttons updated.');
            }

            // Händelselyssnare
            teamSelect.addEventListener('change', (event) => {
                currentFilterTeam = event.target.value;
                console.log('Team selected:', currentFilterTeam);
                if (showMyGamesOnly && currentFilterTeam === 'All Teams') {
                    showMyGamesOnly = false;
                    console.log('Switched to show all games because "All Teams" was selected while "My Games" was active.');
                }
                updateFilterButtons();
                renderSchedule();
            });

            viewAllBtn.addEventListener('click', () => {
                console.log('View All Games button clicked.');
                showMyGamesOnly = false;
                updateFilterButtons();
                renderSchedule();
            });

            myGamesBtn.addEventListener('click', () => {
                console.log('My Games button clicked.');
                if (currentFilterTeam === 'All Teams') {
                    infoMessage.textContent = 'Välj ett lag från rullgardinsmenyn först för att använda filtret "Mina matcher".';
                    console.warn('Cannot filter "My Games" without a selected team.');
                } else {
                    showMyGamesOnly = true;
                    updateFilterButtons();
                    renderSchedule();
                }
            });

            // Initial laddning av data
            async function initializeSchedule() {
                console.log('initializeSchedule called.');
                gameListDiv.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Laddar schema och lagdata...</div>`;
                try {
                    console.time('Fetch Teams CSV');
                    const teamsCsvText = await fetchCsvData(teamsCsvUrl);
                    allTeamsData = parseTeamsCsv(teamsCsvText);
                    console.timeEnd('Fetch Teams CSV');
                    console.log('allTeamsData loaded:', allTeamsData.length, 'teams');

                    console.time('Fetch Schedule CSV');
                    const scheduleCsvText = await fetchCsvData(csvUrl);
                    allGames = parseScheduleCsv(scheduleCsvText);
                    console.timeEnd('Fetch Schedule CSV');
                    console.log('allGames loaded:', allGames.length, 'games');

                    populateTeamDropdown();
                    renderSchedule();
                    updateFilterButtons();
                    console.log('Schedule initialized and rendered successfully.');
                } catch (error) {
                    console.error("Felsökning: Ett fel uppstod vid initialisering av schemat.", error);
                    gameListDiv.innerHTML = `<div class="text-center text-red-600 font-bold col-span-full p-4">
                                                Kunde inte ladda schema eller lagdata. Se konsolen för detaljer. <br>
                                                Kontrollera att båda dina Google Sheets är korrekt publicerade som CSV.
                                                <br>
                                                <a href="https://support.google.com/docs/answer/183950?hl=sv" target="_blank" class="text-blue-600 hover:underline">Hur du publicerar Google Sheet till webben (Google Support)</a>
                                            </div>`;
                }
            }

            initializeSchedule();
        });
    </script>
</body>

</html>