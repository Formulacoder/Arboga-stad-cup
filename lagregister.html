<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagregister</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Light grey background */
            min-height: 100vh;
            /* Ensures background covers entire page */
            display: flex;
            flex-direction: column;
            /* For navbar to be at the top */
            align-items: center;
            justify-content: flex-start;
            /* Adjust for navbar */
            padding: 0;
            /* Remove padding from body */
        }

        .navbar {
            width: 100%;
            background-color: #1a202c;
            /* M√∂rk bakgrund f√∂r navbar */
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            /* Kvar p√• toppen vid scroll */
            top: 0;
            z-index: 1000;
            /* S√§kerst√§ll att den ligger √∂ver annat inneh√•ll */
            display: flex;
            /* Anv√§nd flexbox */
            align-items: center;
            /* Centrera vertikalt */
            justify-content: flex-start;
            /* Starta objekt fr√•n v√§nster */
            flex-wrap: wrap;
            /* Till√•t objekt att bryta rad om utrymmet √§r begr√§nsat */
        }

        .navbar-home-logo {
            height: 2.5rem;
            /* Storlek p√• logotypen som hemknapp */
            margin-right: 1.5rem;
            /* Mer utrymme till h√∂ger om logotypen */
            cursor: pointer;
            border-radius: 9999px;
            /* Rundad */
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
            /* F√∂rhindra att logotypen krymper */
        }

        .navbar-home-logo:hover {
            transform: scale(1.05);
            /* L√§tt f√∂rstoring vid hover */
        }

        .navbar-links-wrapper {
            display: flex;
            flex-wrap: wrap;
            /* Till√•t l√§nkar att bryta rad */
            gap: 0.5rem;
            /* Litet mellanrum mellan l√§nkar */
            flex-grow: 1;
            /* Till√•t l√§nkomslutningen att ta tillg√§ngligt utrymme */
            justify-content: center;
            /* Centrera l√§nkar inom deras omslutning p√• sm√• sk√§rmar om de bryter rad */
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            /* N√•got minskad padding f√∂r kompakthet */
            border-radius: 0.375rem;
            /* rounded-md */
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            white-space: nowrap;
            /* F√∂rhindra att l√§nkar bryter text */
        }

        .navbar a:hover {
            background-color: #4a5568;
            /* Darker grey on hover */
        }

        .content-container {
            max-width: 960px;
            /* max-w-4xl is approx 960px */
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            /* Adjusted padding */
            margin-top: 2rem;
            /* Margin from navbar */
            margin-bottom: 2rem;
            flex-grow: 1;
            /* L√•ter inneh√•llskontainern v√§xa och pressa ner footern */
        }

        /* Grid container for teams - now for group sections */
        #team-list {
            display: flex;
            /* Changed to flex for stacking group sections */
            flex-direction: column;
            gap: 2.5rem;
            /* Space between group sections */
        }

        .team-group-section {
            width: 100%;
        }

        .team-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            /* Adjusted for 2 columns on larger screens */
            gap: 1.5rem;
            /* Space between cards */
        }

        /* Adjust grid-template-columns for sm breakpoint (mobile) to be 1 column */
        @media (min-width: 640px) and (max-width: 767px) {
            .team-cards-grid {
                grid-template-columns: 1fr;
                /* Force 1 column on small tablets/large phones if needed */
            }
        }


        /* Base team card styling (initial collapsed view) */
        .team-card-compact {
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-lg */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            /* Shadow for depth */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            overflow: hidden;
            /* Ensures rounded corners apply correctly */
            display: flex;
            flex-direction: column;
            /* Standard: column for small screens */
            align-items: center;
            /* Center items for small screens */
            text-align: center;
            /* Center text for small screens */
            padding: 1.5rem;
            /* Initial padding */
        }

        @media (min-width: 768px) {

            /* Adjust for larger screens */
            .team-card-compact {
                flex-direction: row;
                /* Row for larger screens */
                justify-content: flex-start;
                /* Align items to start */
                text-align: left;
                /* Align text to left */
                padding: 1rem 1.5rem;
                /* Slightly less vertical padding */
            }
        }

        .team-card-compact:hover {
            transform: translateY(-3px);
            /* Subtle lift on hover */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            /* Slightly darker shadow on hover */
        }

        .team-logo-main {
            width: 4rem;
            /* Smaller logo in compact view */
            height: 4rem;
            border-radius: 9999px;
            /* Circular */
            object-fit: cover;
            margin-bottom: 0.5rem;
            /* Space below logo on small screens */
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        @media (min-width: 768px) {
            .team-logo-main {
                margin-right: 1rem;
                /* Space to the right of logo on larger screens */
                margin-bottom: 0;
                /* No bottom margin on larger screens */
            }
        }

        .team-info-compact {
            flex-grow: 1;
            /* Allows this block to take available space */
        }

        .team-name-compact {
            font-size: 1.25rem;
            /* text-xl, slightly smaller */
            font-weight: 700;
            /* font-bold */
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .team-details-line {
            font-size: 0.9rem;
            /* Smaller text for details */
            color: #6b7280;
            margin-bottom: 0.2rem;
            display: flex;
            /* For inline label-value */
            align-items: center;
            justify-content: center;
            /* Center on small screens */
        }

        @media (min-width: 768px) {
            .team-details-line {
                justify-content: flex-start;
                /* Left align on larger screens */
            }
        }

        .team-details-line strong {
            font-weight: 600;
            margin-right: 0.3rem;
        }

        /* Expanded state styling */
        .team-card-expanded {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            /* More prominent shadow when expanded */
            padding: 1.5rem;
            transition: all 0.5s ease-in-out;
            /* Smooth transition for expand/collapse */
            display: flex;
            flex-direction: column;
            width: 100%;
            /* Take full width when expanded */
            grid-column: 1 / -1;
            /* Make it span all columns in the grid */
        }

        /* Header for expandable team card when expanded */
        .team-expanded-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            /* Space before details */
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .team-expanded-header-content {
            display: flex;
            align-items: center;
        }

        .team-logo-expanded {
            width: 4rem;
            /* Smaller logo in expanded header */
            height: 4rem;
            border-radius: 9999px;
            object-fit: cover;
            margin-right: 1rem;
        }

        .team-name-expanded {
            font-size: 2rem;
            /* text-3xl */
            font-weight: 800;
            /* font-extrabold */
            color: #1a202c;
        }

        /* Common detail item styling */
        .detail-item {
            margin-bottom: 0.6rem;
            font-size: 0.95rem;
            color: #4a5568;
        }

        .detail-item strong {
            color: #1a202c;
            margin-right: 0.4rem;
        }

        .detail-item p {
            /* For descriptions that might have paragraphs */
            margin-top: 0.5rem;
            white-space: pre-wrap;
            /* Preserve whitespace and line breaks */
        }

        /* Collapsible sections within expanded card */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f0f4f8;
            /* Lighter background for nested headers */
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #2d3748;
            transition: background-color 0.2s ease-in-out;
        }

        .collapsible-header:hover {
            background-color: #e2e8f0;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            /* Initial padding */
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }

        .collapsible-content.expanded {
            max-height: 1500px;
            /* Sufficiently large to show content */
            padding-bottom: 1rem;
        }

        .toggle-icon {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a5568;
            transition: transform 0.3s ease-in-out;
        }

        /* Player List styling */
        .player-list {
            list-style: none;
            padding-left: 0;
            margin-top: 0.5rem;
        }

        .player-list li {
            padding: 0.3rem 0;
            display: flex;
            align-items: center;
            border-bottom: 1px dashed #cbd5e0;
        }

        .player-list li:last-child {
            border-bottom: none;
        }

        .player-role-icon {
            margin-right: 0.5rem;
            font-size: 0.9em;
            color: #4a5568;
        }

        .player-name {
            font-weight: 500;
            color: #2d3748;
        }

        .player-number {
            font-size: 0.9em;
            color: #6b7280;
            margin-left: auto;
            /* Push number to the right */
            flex-shrink: 0;
        }

        /* Footer styling */
        .footer {
            width: 100%;
            background-color: #1a202c;
            /* M√∂rk bakgrund f√∂r footer */
            padding: 1.5rem;
            text-align: center;
            margin-top: auto;
            /* Trycker ner footern till botten */
        }

        .footer-logo {
            max-width: 100%;
            /* Anpassa till sk√§rmbredden */
            height: 6rem;
            /* FAST H√ñJD F√ñR FOTLOGOTYPEN, √ñKAD FR√ÖN 4REM TILL 6REM */
            object-fit: contain;
            /* Beh√•ll proportioner, se till att hela bilden syns */
            display: block;
            /* Centrera bilden */
            margin: 0 auto;
            /* Centrera bilden horisontellt */
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {

            /* For mobile (sm breakpoint) */
            .navbar {
                flex-direction: column;
                /* Stapla logotyp och l√§nkar vertikalt */
                align-items: center;
                /* Centrera allt */
            }

            .navbar-home-logo {
                margin-right: 0;
                /* Ingen marginal till h√∂ger om logotypen om den √§r centrerad */
                margin-bottom: 1rem;
                /* Avst√•nd till l√§nkarna nedanf√∂r */
            }

            .navbar-links-wrapper {
                width: 100%;
                /* Ta full bredd under logotypen */
                justify-content: center;
                /* Centrera l√§nkar i en rad som bryter */
            }

            .navbar a {
                width: auto;
                /* L√•t l√§nkarna best√§mma sin egen bredd */
            }

            .team-expanded-header {
                flex-wrap: wrap;
                justify-content: center;
                text-align: center;
            }

            .team-logo-expanded {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }

            .team-name-expanded {
                font-size: 1.75rem;
                width: 100%;
            }

            .toggle-icon {
                position: absolute;
                /* Position toggle icon absolutely */
                top: 1rem;
                right: 1rem;
            }

            .team-expanded-header {
                position: relative;
                /* Make header position relative for absolute icon */
            }

            .collapsible-content {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }
    </style>
</head>

<body class="flex flex-col">
    <!-- Global Navigation Menu -->
    <nav class="navbar">
        <a href="index.html">
            <img src="https://i.imgur.com/pwnWIDU.png" alt="Arboga Stad SK Logo" class="navbar-home-logo">
        </a>
        <div class="navbar-links-wrapper">
            <a href="index.html">Startsida</a>
            <a href="fotbollsschema.html">Spelschema</a>
            <a href="lagregister.html">Lagregister</a>
            <a href="spelaregister.html">Spelarregister</a>
            <a href="tabeller.html">Tabeller</a>
            <a href="sponsorer.html">Samarbetspartners</a>
            <a href="aktiviteter.html">Aktiviteter</a>
            <a href="efterfesten.html">Efterfesten</a>
        </div>
    </nav>

    <div class="content-container">
        <!-- Header Section -->
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Lagregister</h1>
            <p class="text-lg text-gray-600">√ñversikt √∂ver alla deltagande lag.</p>
        </header>

        <!-- Team Listing Section -->
        <div id="team-list">
            <!-- Team cards will be rendered here by JavaScript -->
            <div class="text-center text-gray-500 p-8 col-span-full">Laddar lagregister...</div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer class="footer">
        <img src="https://i.imgur.com/9q8c3ab.png" alt="Cup Footer Logo" class="footer-logo">
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed for lagregister.html');

            // !!! IMPORTANT !!!
            // This URL points to your PUB_TEAMINFO Google Sheet.
            // Ensure your Google Sheet is published as "Comma-separated values (.csv)".
            const teamsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=213368947&single=true&output=csv';
            // This URL points to your PUB_PLAYERINFO Google Sheet.
            const playerCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=1028240933&single=true&output=csv';

            const teamListDiv = document.getElementById('team-list');

            let allTeams = []; // Stores raw team data from PUB_TEAMINFO CSV
            let allPlayers = []; // Stores raw player data from PUB_PLAYERINFO CSV
            let expandedTeamCard = null; // Tracks the currently expanded team card

            /**
             * Fetches CSV data from the given URL.
             * @param {string} url The URL to the CSV file.
             * @returns {Promise<string>} A promise that resolves with the CSV text.
             */
            async function fetchCsvData(url) {
                console.log(`Attempting to fetch CSV from: ${url}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorMsg = `HTTP Error! status: ${response.status} fetching ${url}`;
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }
                    console.log(`Successfully fetched CSV from: ${url}`);
                    return await response.text();
                } catch (error) {
                    console.error('Error fetching CSV data from:', url, error);
                    // Display a general error message for CSV loading issues
                    teamListDiv.innerHTML = `<div class="text-center text-red-600 font-bold col-span-full p-4">
                                                Fel vid laddning av data. Se till att dina Google Sheets √§r korrekt publicerade som CSV.
                                                <br><a href="https://support.google.com/docs/answer/183950?hl=sv" target="_blank" class="text-blue-600 hover:underline">Hur du publicerar Google Sheet till webben (Google Support)</a>
                                            </div>`;
                    throw error; // Re-throw to propagate error for Promise.all
                }
            }

            /**
             * A robust CSV parsing function that handles fields with commas and quotes.
             * Assumes that fields containing commas are enclosed in double quotes.
             * Also handles double quotes within quoted fields (by doubling them, e.g., "He said ""Hello""").
             * @param {string} csvText The CSV content as a string.
             * @returns {Array<Array<string>>} An array of rows, where each row is an array of string values.
             */
            function parseRobustCsv(csvText) {
                const rows = [];
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    return [];
                }

                // Process data rows (skip header row for internal parsing)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const values = [];
                    let inQuote = false;
                    let currentField = '';

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const nextChar = line[j + 1];

                        if (char === '"') {
                            if (inQuote && nextChar === '"') {
                                currentField += char;
                                j++;
                            } else {
                                inQuote = !inQuote;
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField.trim());
                    rows.push(values);
                }
                console.log(`Parsed ${rows.length - 1} data rows.`);
                return rows.slice(1); // Return all rows except the header row
            }

            /**
             * Parsar den robusta CSV-texten till en array av lagobjekt (fr√•n PUB_TEAMINFO).
             * VIKTIGT: Denna funktion f√∂rv√§ntar sig kolumnerna i DENNA SPECIFIKA ORDNING:
             * Lagnamn|Logo|Lagkapten|Samarbetspartner|Grupp|Spelare (K=Kapten, MV=Keeper)|TEAM_DESCRIPTION|TEAM_STYLE|SECRET_WEAPON|HIGHLIGHT_OPS|GROUP_THREAT|TEAM_EXP|CELEBRATION|MOTTO|BetStats
             * @param {string} csvText The CSV content as a string.
             * @returns {Array<Object>} An array of team objects.
             */
            function parseTeamsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) {
                    console.warn("Teams CSV is empty or parsing resulted in no data.");
                    return [];
                }

                const teams = [];
                const headers = [
                    'teamName', 'logo', 'captainName', 'sponsor', 'group', 'playersRaw',
                    'teamDescription', 'teamStyle', 'secretWeapon', 'highlightOps',
                    'groupThreat', 'teamExp', 'celebration', 'motto', 'betStats'
                ];

                rawRows.forEach((values, index) => {
                    if (values.length >= 15) { // Ensure enough columns for all headers
                        const team = {
                            teamName: values[0] ? values[0].trim() : 'N/A',
                            logo: values[1] ? values[1].trim() : 'https://placehold.co/100x100/aabbcc/ffffff?text=Team+Logo',
                            captainName: values[2] ? values[2].trim() : 'N/A',
                            sponsor: values[3] ? values[3].trim() : 'N/A',
                            group: values[4] ? values[4].trim() : 'N/A',
                            playersRaw: values[5] ? values[5].trim() : '', // This field won't be used directly now, but keep for parsing consistency
                            teamDescription: values[6] ? values[6].trim() : 'N/A',
                            teamStyle: values[7] ? values[7].trim() : 'N/A',
                            secretWeapon: values[8] ? values[8].trim() : 'N/A',
                            highlightOps: values[9] ? values[9].trim() : 'N/A',
                            groupThreat: values[10] ? values[10].trim() : 'N/A',
                            teamExp: values[11] ? values[11].trim() : 'N/A',
                            celebration: values[12] ? values[12].trim() : 'N/A',
                            motto: values[13] ? values[13].trim() : 'N/A',
                            betStats: values[14] ? values[14].trim() : 'N/A'
                        };
                        teams.push(team);
                    } else {
                        console.warn(`Skipping invalid team row ${index + 2}: Not enough columns (expected ${headers.length}, found ${values.length}). Row content: "${values.join(',')}"`);
                    }
                });
                return teams;
            }

            /**
             * Parsar CSV-text till en array av spelarobjekt (fr√•n PUB_PLAYERINFO).
             * VIKTIGT: Denna funktion f√∂rv√§ntar sig kolumnerna i DENNA SPECIFIKA ORDNING:
             * UID|NAME|KAPTEN|ROLL|LAG|SPONSOR|NR|GROUP|NICKNAME|NICKNAME_EXT|CUP_EXPERIENCE|FOOTBALL_EXPERIENCE|FAVORITE_PLAYER_AND_TEAM|OUTSIDE_FOOTBALL|UNEXPECTED_ABOUT_YOU|GAME_RIITUAL|CUP_CRUSH|EGO_DEATH_TUNNEL|BLAME_IF_LOSE|CELEBRATE_FINAL|STATS_YELLOW|STATS_RED|STATS_GOALS
             * @param {string} csvText The CSV content as a string.
             * @returns {Array<Object>} An array of player objects.
             */
            function parsePlayersCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) {
                    console.warn("Players CSV is empty or parsing resulted in no data.");
                    return [];
                }

                const players = [];
                // Nya headers f√∂r PUB_PLAYERINFO
                const headers = [
                    'uid', 'name', 'isCaptainRaw', 'role', 'team', 'sponsor', 'number', 'group',
                    'nickname', 'nicknameExt', 'cupExperience', 'footballExperience',
                    'favoritePlayerAndTeam', 'outsideFootball', 'unexpectedAboutYou',
                    'gameRitual', 'cupCrush', 'egoDeathTunnel', 'blameIfLose',
                    'celebrateFinal', 'statsYellow', 'statsRed', 'statsGoals'
                ];

                rawRows.forEach((values, index) => { // B√∂rja fr√•n index 0 eftersom parseRobustCsv redan hanterat rubrikraden
                    if (values.length >= headers.length) {
                        const player = {};
                        headers.forEach((header, colIndex) => {
                            player[header] = values[colIndex] ? values[colIndex].trim() : 'N/A';
                        });
                        player.isCaptain = player.isCaptainRaw.toLowerCase() === 'k' ||
                            player.isCaptainRaw.toLowerCase() === 'kapten' ||
                            player.isCaptainRaw.toLowerCase() === 'ja';
                        player.isGoalkeeper = player.role.toLowerCase() === 'mv' ||
                            player.role.toLowerCase() === 'keeper' ||
                            player.role.toLowerCase() === 'm√•lvakt';
                        players.push(player);
                    } else {
                        console.warn(`Skipping invalid player row ${index + 2}: Not enough columns (expected ${headers.length}, found ${values.length}).`);
                    }
                });
                return players;
            }

            /**
             * Renders the team register with expand/collapse functionality.
             */
            function renderTeamRegister() {
                console.log('renderTeamRegister called. Clearing team list.');
                teamListDiv.innerHTML = ''; // Clear previous team cards

                if (allTeams.length === 0) {
                    teamListDiv.innerHTML = `<div class="text-center text-gray-500 col-span-full p-8">Inga lag hittades i registret.</div>`;
                    console.warn('No teams to display.');
                    return;
                }

                // Group by group after initial sorting
                const groupedByGroup = allTeams.reduce((acc, team) => {
                    const group = team.group || 'Ok√§nd Grupp'; // Fallback for unknown group
                    if (!acc[group]) {
                        acc[group] = [];
                    }
                    acc[group].push(team);
                    return acc;
                }, {});

                // Sort group names alphabetically to ensure consistent display order
                const sortedGroupNames = Object.keys(groupedByGroup).sort();
                console.log(`Found ${sortedGroupNames.length} groups.`);

                sortedGroupNames.forEach(groupName => {
                    const groupSection = document.createElement('div');
                    groupSection.className = 'team-group-section';

                    groupSection.innerHTML = `
                        <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6">${groupName}</h2>
                        <div class="team-cards-grid">
                            <!-- Team cards for this group will go here -->
                        </div>
                    `;
                    const groupGrid = groupSection.querySelector('.team-cards-grid');

                    groupedByGroup[groupName].forEach(team => {
                        const teamCard = document.createElement('div');
                        teamCard.className = `team-card-compact`;
                        teamCard.setAttribute('data-team-name', team.teamName);

                        teamCard.innerHTML = `
                            <img src="${team.logo}" alt="${team.teamName} Logo" class="team-logo-main" onerror="this.onerror=null; this.src='https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo';">
                            <div class="team-info-compact">
                                <h2 class="team-name-compact">${team.teamName}</h2>
                                <p class="team-details-line"><strong>Kapten:</strong> ${team.captainName || 'N/A'}</p>
                                <p class="team-details-line"><strong>Grupp:</strong> ${team.group || 'N/A'}</p>
                                <p class="team-details-line"><strong>Partner:</strong> ${team.sponsor || 'N/A'}</p>
                                <p class="team-details-line"><strong>Motto:</strong> ${team.motto || 'N/A'}</p>
                            </div>
                        `;
                        groupGrid.appendChild(teamCard);

                        // Create the expanded content section (initially hidden)
                        const expandedContentDiv = document.createElement('div');
                        expandedContentDiv.className = `team-card-expanded hidden`; // Start hidden
                        expandedContentDiv.setAttribute('id', `team-expanded-${team.teamName.replace(/\s+/g, '-')}`);

                        // Filter players for the current team
                        const playersInTeam = allPlayers.filter(player => player.team === team.teamName);
                        playersInTeam.sort((a, b) => a.name.localeCompare(b.name));

                        const playerListHtml = playersInTeam.map(player => `
                            <li>
                                ${player.isCaptain ? '<span class="player-role-icon" title="Kapten">üëë</span>' : ''}
                                ${player.isGoalkeeper ? '<span class="player-role-icon" title="M√•lvakt">üß§</span>' : ''}
                                <span class="player-name">${player.name}</span>
                                ${player.number && player.number !== 'N/A' ? `<span class="player-number">Nr: ${player.number}</span>` : ''}
                            </li>
                        `).join('');

                        expandedContentDiv.innerHTML = `
                            <div class="team-expanded-header">
                                <div class="team-expanded-header-content">
                                    <img src="${team.logo}" alt="${team.teamName} Logo" class="team-logo-expanded" onerror="this.onerror=null; this.src='https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo';">
                                    <h2 class="team-name-expanded">${team.teamName}</h2>
                                </div>
                                <span class="toggle-icon cursor-pointer">‚àí</span>
                            </div>

                            <div class="basic-details mt-4">
                                <p class="detail-item"><strong>Lagkapten:</strong> ${team.captainName || 'N/A'}</p>
                                <p class="detail-item"><strong>Grupp:</strong> ${team.group || 'N/A'}</p>
                                <p class="detail-item"><strong>Samarbetspartner:</strong> ${team.sponsor || 'N/A'}</p>
                                <p class="detail-item"><strong>Motto:</strong> ${team.motto || 'N/A'}</p>
                            </div>

                            <div class="collapsible-header" data-target="#more-about-team-${team.teamName.replace(/\s+/g, '-')}" role="button" tabindex="0">
                                <span>Mer om laget</span>
                                <span class="toggle-icon">+</span>
                            </div>
                            <div id="more-about-team-${team.teamName.replace(/\s+/g, '-')}" class="collapsible-content">
                                ${team.teamDescription && team.teamDescription !== 'N/A' ? `<p class="detail-item"><strong>Beskrivning:</strong> ${team.teamDescription}</p>` : ''}
                                ${team.teamStyle && team.teamStyle !== 'N/A' ? `<p class="detail-item"><strong>Spelstil:</strong> ${team.teamStyle}</p>` : ''}
                                ${team.secretWeapon && team.secretWeapon !== 'N/A' ? `<p class="detail-item"><strong>Hemlig Vapen:</strong> ${team.secretWeapon}</p>` : ''}
                                ${team.highlightOps && team.highlightOps !== 'N/A' ? `<p class="detail-item"><strong>Highlight Ops:</strong> ${team.highlightOps}</p>` : ''}
                                ${team.groupThreat && team.groupThreat !== 'N/A' ? `<p class="detail-item"><strong>St√∂rsta Hotet (Grupp):</strong> ${team.groupThreat}</p>` : ''}
                                ${team.teamExp && team.teamExp !== 'N/A' ? `<p class="detail-item"><strong>Tidigare Erfarenhet:</strong> ${team.teamExp}</p>` : ''}
                                ${team.celebration && team.celebration !== 'N/A' ? `<p class="detail-item"><strong>M√•lfirande:</strong> ${team.celebration}</p>` : ''}
                                ${team.betStats && team.betStats !== 'N/A' ? `<p class="detail-item"><strong>BetStats:</strong> ${team.betStats}</p>` : ''}
                            </div>

                            <div class="collapsible-header" data-target="#squad-list-${team.teamName.replace(/\s+/g, '-')}" role="button" tabindex="0">
                                <span>Truppen (${playersInTeam.length} spelare)</span>
                                <span class="toggle-icon">+</span>
                            </div>
                            <div id="squad-list-${team.teamName.replace(/\s+/g, '-')}" class="collapsible-content">
                                <ul class="player-list">
                                    ${playerListHtml || '<li>Inga spelare listade.</li>'}
                                </ul>
                            </div>
                        `;
                        // Expanded cards are appended directly to teamListDiv, not the groupGrid,
                        // as they take full width and are rendered in place of the compact card.
                        teamListDiv.appendChild(expandedContentDiv);
                    });
                    teamListDiv.appendChild(groupSection); // Append the whole group section
                });
                console.log(`Rendered teams, grouped by group.`);

                // Event listeners for initial team card clicks (to show expanded view)
                document.querySelectorAll('.team-card-compact').forEach(card => {
                    card.addEventListener('click', () => {
                        const teamName = card.dataset.teamName;
                        const expandedCardId = `team-expanded-${teamName.replace(/\s+/g, '-')}`;
                        const expandedCard = document.getElementById(expandedCardId);

                        // Collapse previously expanded card if any
                        if (expandedTeamCard && expandedTeamCard !== expandedCard) {
                            expandedTeamCard.classList.add('hidden');
                            const prevTeamName = expandedTeamCard.id.replace('team-expanded-', '').replace(/-/g, ' ');
                            const prevCompactCard = document.querySelector(`.team-card-compact[data-team-name="${prevTeamName}"]`);
                            if (prevCompactCard) {
                                prevCompactCard.classList.remove('hidden');
                            }
                            expandedTeamCard.querySelectorAll('.collapsible-content.expanded').forEach(content => {
                                content.classList.remove('expanded');
                                const header = content.previousElementSibling;
                                if (header) header.querySelector('.toggle-icon').textContent = '+';
                            });
                        }

                        if (expandedCard) {
                            expandedCard.classList.toggle('hidden');
                            card.classList.toggle('hidden');
                            expandedTeamCard = expandedCard.classList.contains('hidden') ? null : expandedCard;
                            console.log(`Team "${teamName}" card toggled. Expanded: ${!expandedCard.classList.contains('hidden')}`);
                        }
                    });
                });

                // Event listener for the toggle icon/header of the expanded card (to collapse it)
                document.querySelectorAll('.team-expanded-header .toggle-icon').forEach(icon => {
                    icon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const expandedCard = icon.closest('.team-card-expanded');
                        if (expandedCard) {
                            expandedCard.classList.add('hidden');
                            const teamName = expandedCard.id.replace('team-expanded-', '').replace(/-/g, ' ');
                            const compactCard = document.querySelector(`.team-card-compact[data-team-name="${teamName}"]`);
                            if (compactCard) {
                                compactCard.classList.remove('hidden');
                            }
                            expandedTeamCard = null;
                            expandedCard.querySelectorAll('.collapsible-content.expanded').forEach(content => {
                                content.classList.remove('expanded');
                                const header = content.previousElementSibling;
                                if (header) header.querySelector('.toggle-icon').textContent = '+';
                            });
                            console.log(`Team "${teamName}" expanded card collapsed via icon.`);
                        }
                    });
                });
                document.querySelectorAll('.team-expanded-header').forEach(header => {
                    header.addEventListener('click', (event) => {
                        if (!event.target.classList.contains('toggle-icon')) {
                            const expandedCard = header.closest('.team-card-expanded');
                            if (expandedCard) {
                                expandedCard.classList.add('hidden');
                                const teamName = expandedCard.id.replace('team-expanded-', '').replace(/-/g, ' ');
                                const compactCard = document.querySelector(`.team-card-compact[data-team-name="${teamName}"]`);
                                if (compactCard) {
                                    compactCard.classList.remove('hidden');
                                }
                                expandedTeamCard = null;
                                expandedCard.querySelectorAll('.collapsible-content.expanded').forEach(content => {
                                    content.classList.remove('expanded');
                                    const header = content.previousElementSibling;
                                    if (header) header.querySelector('.toggle-icon').textContent = '+';
                                });
                                console.log(`Team "${teamName}" expanded card collapsed via header click.`);
                            }
                        }
                    });
                });

                // Event listeners for nested collapsible headers ("Mer om laget", "Truppen")
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const targetId = header.dataset.target;
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            targetElement.classList.toggle('expanded');
                            const toggleIcon = header.querySelector('.toggle-icon');
                            toggleIcon.textContent = targetElement.classList.contains('expanded') ? '‚àí' : '+';
                            console.log(`Collapsible section "${targetId}" toggled. Expanded: ${targetElement.classList.contains('expanded')}`);
                        }
                    });
                });
            }

            // Initial data load
            async function initializeTeamRegister() {
                console.log('initializeTeamRegister called.');
                teamListDiv.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Laddar lagregister och spelardata...</div>`;
                try {
                    console.time('Fetch Teams CSV');
                    const teamsCsvText = await fetchCsvData(teamsCsvUrl);
                    allTeams = parseTeamsCsv(teamsCsvText);
                    console.timeEnd('Fetch Teams CSV');
                    console.log('allTeams loaded:', allTeams.length, 'teams');

                    console.time('Fetch Players CSV');
                    const playerCsvText = await fetchCsvData(playerCsvUrl);
                    allPlayers = parsePlayersCsv(playerCsvText);
                    console.timeEnd('Fetch Players CSV');
                    console.log('allPlayers loaded:', allPlayers.length, 'players');

                    // Enrich teams with player count and info presence for sorting
                    allTeams.forEach(team => {
                        team.playerCount = allPlayers.filter(p => p.team === team.teamName).length;
                        team.hasDetailedInfo = (team.teamDescription && team.teamDescription !== 'N/A') || team.playerCount > 0;
                    });

                    // Sort teams: priority to those with detailed info (true first), then by group name, then by team name
                    allTeams.sort((a, b) => {
                        if (a.hasDetailedInfo !== b.hasDetailedInfo) {
                            return b.hasDetailedInfo - a.hasDetailedInfo; // true (1) comes before false (0)
                        }
                        if (a.group !== b.group) {
                            return a.group.localeCompare(b.group);
                        }
                        return a.teamName.localeCompare(b.teamName);
                    });
                    console.log('Teams sorted.');

                    renderTeamRegister();
                    console.log('Team register initialized and rendered successfully.');
                } catch (error) {
                    console.error("Fels√∂kning: Ett fel uppstod vid initialisering av lagregistret.", error);
                }
            }

            initializeTeamRegister();
        });
    </script>
</body>

</html>