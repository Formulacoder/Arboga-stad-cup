<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagregister</title>
    <!-- Tailwind CSS CDN för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Ljusgrå bakgrund */
            min-height: 100vh;
            /* Säkerställer att bakgrunden täcker hela sidan */
            display: flex;
            flex-direction: column;
            /* För att navbaren ska ligga överst */
            align-items: center;
            justify-content: flex-start;
            /* Justera för navbar */
            padding: 0;
            /* Ta bort padding från body */
        }

        .navbar {
            width: 100%;
            background-color: #1a202c;
            /* Mörk bakgrund för navbar */
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            /* Kvar på toppen vid scroll */
            top: 0;
            z-index: 1000;
            /* Säkerställ att den ligger över annat innehåll */
            display: flex;
            /* Använd flexbox */
            align-items: center;
            /* Centrera vertikalt */
            justify-content: flex-start;
            /* Starta objekt från vänster */
            flex-wrap: wrap;
            /* Tillåt objekt att bryta rad om utrymmet är begränsat */
        }

        .navbar-home-logo {
            height: 2.5rem;
            /* Storlek på logotypen som hemknapp */
            margin-right: 1.5rem;
            /* Mer utrymme till höger om logotypen */
            cursor: pointer;
            border-radius: 9999px;
            /* Rundad */
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
            /* Förhindra att logotypen krymper */
        }

        .navbar-home-logo:hover {
            transform: scale(1.05);
            /* Lätt förstoring vid hover */
        }

        .navbar-links-wrapper {
            display: flex;
            flex-wrap: wrap;
            /* Tillåt länkar att bryta rad */
            gap: 0.5rem;
            /* Litet mellanrum mellan länkar */
            flex-grow: 1;
            /* Tillåt länkomslutningen att ta tillgängligt utrymme */
            justify-content: center;
            /* Centrera länkar inom deras omslutning på små skärmar om de bryter rad */
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            /* Något minskad padding för kompakthet */
            border-radius: 0.375rem;
            /* rounded-md */
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            white-space: nowrap;
            /* Förhindra att länkar bryter text */
        }

        .navbar a:hover {
            background-color: #4a5568;
            /* Mörkare grå vid hover */
        }

        .content-container {
            max-width: 960px;
            /* max-w-4xl är ca 960px */
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            /* Justerad padding */
            margin-top: 2rem;
            /* Marginal från navbar */
            margin-bottom: 2rem;
            flex-grow: 1;
            /* Låter innehållskontainern växa och pressa ner footern */
        }

        /* ... (keep existing body, navbar, content-container, footer styles) ... */

        /* Group Filter Buttons - no changes needed from previous state */
        .group-filter-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f7fafc;
            border-radius: 0.75rem;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .group-filter-button {
            padding: 0.6rem 1.2rem;
            background-color: #e2e8f0;
            color: #4a5568;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.1s ease-in-out;
            flex-grow: 1;
            text-align: center;
            min-width: 80px;
            white-space: nowrap;
        }

        .group-filter-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .group-filter-button:hover:not(.active) {
            background-color: #cbd5e0;
        }

        /* Team Card Grid */
        #team-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            /* Min width slightly increased */
            gap: 1.5rem;
        }

        /* INDIVIDUAL TEAM CARD STYLING */
        .team-list-item {
            /* The main card container */
            background-color: #ffffff;
            /* Brighter card background */
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 1.25rem;
            /* Increased padding */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            min-height: 280px;
            /* Ensure a minimum height for consistency */
        }

        .team-list-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        /* Row 1: Logo/Group + Name/Captain */
        .team-card-row1 {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* Align items to the top of the row */
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .team-card-row1-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center logo and group tag */
            flex-shrink: 0;
        }

        .team-logo-card {
            /* Specific for this card's logo */
            width: 70px;
            /* Larger logo */
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e2e8f0;
            margin-bottom: 0.5rem;
            /* Space before group tag */
        }

        .team-list-group-card {
            /* Group tag specific for card */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            /* Smaller group tag text */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Group specific colors will be added via JS */
        .group-a {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        /* Light Red */
        .group-b {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* Light Blue */
        .group-c {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Light Green */
        .group-d {
            background-color: #fef3c7;
            color: #b45309;
        }

        /* Light Yellow/Amber */
        .group-default {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        /* Light Gray */


        .team-card-row1-right {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /* Align text to the left */
            flex-grow: 1;
            min-width: 0;
            /* Allows text to wrap properly */
        }

        .team-name-card {
            font-size: 1.6rem;
            /* Larger team name */
            font-weight: 800;
            color: #1a202c;
            line-height: 1.2;
            margin-bottom: 0.1rem;
        }

        .team-captain-card {
            font-size: 0.85rem;
            color: #4a5568;
        }

        /* Row 2: Info - Players, Style, Motto, ShortDesc */
        .team-card-row2 {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #374151;
            text-align: left;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 0;
        }

        .team-card-row2 p {
            margin-bottom: 0.35rem;
        }

        .team-card-row2 strong {
            font-weight: 600;
            color: #1f2937;
        }

        .short-description-card {
            font-style: italic;
            color: #4b5563;
            max-height: 4.5em;
            /* approx 3 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            /* Note: Pure CSS ellipsis on multi-line is tricky, JS might be needed for perfect "..." */
        }

        .short-description-card .read-more-link {
            font-weight: 600;
            color: #3b82f6;
            text-decoration: none;
            font-style: normal;
        }

        .short-description-card .read-more-link:hover {
            text-decoration: underline;
        }


        /* Row 3: Sponsor / Hub Link */
        .team-card-row3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            /* Pushes this row to the bottom of the card */
            padding-top: 0.75rem;
        }

        .sponsor-info-card {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #6b7280;
            flex-grow: 1;
            /* Allows sponsor info to take available space */
        }

        .sponsor-logo-small-card {
            height: 1.5rem;
            /* Slightly larger sponsor logo */
            max-width: 70px;
            /* Max width for sponsor logo */
            object-fit: contain;
        }

        .team-hub-link-card {
            /* Specific for card button */
            background-color: #3b82f6;
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
            flex-shrink: 0;
            /* Prevent button from shrinking */
        }

        .team-hub-link-card:hover {
            background-color: #2563eb;
        }

        .team-hub-link-card.full-width {
            width: 100%;
            text-align: center;
        }


        /* Responsive adjustments */
        @media (max-width: 640px) {
            /* ... (navbar responsive styles remain the same) ... */

            #team-list {
                grid-template-columns: 1fr;
                /* Single column for mobile */
            }

            .team-card-row1 {
                flex-direction: column;
                /* Stack left and right on mobile */
                align-items: center;
                /* Center items in the column */
                text-align: center;
            }

            .team-card-row1-right {
                align-items: center;
                /* Center team name and captain */
            }

            .team-card-row2 {
                text-align: center;
            }

            .team-card-row3 {
                flex-direction: column;
                gap: 0.75rem;
            }

            .team-hub-link-card.full-width,
            .team-hub-link-card {
                width: 100%;
                text-align: center;
            }

            .sponsor-info-card {
                justify-content: center;
            }
        }

        /* Footer styling */
        .footer {
            width: 100%;
            background-color: #1a202c;
            /* Mörk bakgrund för footer */
            padding: 1.5rem;
            text-align: center;
            margin-top: auto;
            /* Trycker ner footern till botten */
        }

        .footer-logo {
            max-width: 100%;
            /* Anpassa till skärmbredden */
            height: 6rem;
            /* FAST HÖJD FÖR FOTLOGOTYPEN, ÖKAD FRÅN 4REM TILL 6REM */
            object-fit: contain;
            /* Behåll proportioner, se till att hela bilden syns */
            display: block;
            /* Centrera bilden */
            margin: 0 auto;
            /* Centrera bilden horisontellt */
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {

            /* Små skärmar (sm breakpoint och nedåt) */
            .navbar {
                flex-direction: column;
                align-items: center;
            }

            .navbar-home-logo {
                margin-right: 0;
                margin-bottom: 1rem;
            }

            .navbar-links-wrapper {
                width: 100%;
                justify-content: center;
            }

            .navbar a {
                width: auto;
            }

            /* Team List adjustments for mobile */
            #team-list {
                grid-template-columns: 1fr;
                /* Enkel kolumn för mobil */
            }

            .team-list-item {
                /* Ytterligare justeringar för mobila listobjekt */
                flex-direction: column;
                /* Stapla detaljer vertikalt på mobil */
                align-items: flex-start;
                padding: 0.75rem 1rem;
            }

            .team-summary {
                /* Säkerställ att sammanfattningsdelen staplas vertikalt på mobil */
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .team-main-info {
                width: 100%;
                justify-content: flex-start;
                margin-bottom: 0;
                min-width: unset;
            }

            .team-list-group {
                margin-left: 0;
                width: 100%;
                text-align: left;
                min-width: unset;
            }

            .team-list-details-summary {
                /* Full bredd på mobil */
                width: 100%;
                margin-left: 0;
                text-align: left;
                /* Justera till vänster på mobil */
                margin-top: 0.5rem;
                justify-content: flex-start;
                /* Justera detaljer till vänster */
            }

            .team-list-details-summary .sponsor-display {
                justify-content: flex-start;
                /* Justera vänster på mobil */
            }

            /* Säkerställ att textetiketter är synliga på mobil */
            .team-list-stat-item span.md\:hidden {
                display: inline;
            }
        }

        @media (min-width: 641px) {

            /* Justera md:hidden beteende för desktop */
            .team-list-stat-item span.md\:hidden {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Global Navigationsmeny -->
    <nav class="navbar">
        <a href="index.html">
            <img src="https://i.imgur.com/pwnWIDU.png" alt="Arboga Stad SK Logo" class="navbar-home-logo"
                onerror="this.onerror=null; this.src='https://placehold.co/100x100/aabbcc/ffffff?text=Hem+Logo';">
        </a>
        <div class="navbar-links-wrapper">
            <a href="index.html">Startsida</a>
            <a href="fotbollsschema.html">Spelschema</a>
            <a href="lagregister.html">Lagregister</a>
            <a href="tabeller.html">Tabeller</a>
            <a href="sponsorer.html">Samarbetspartners</a>
            <a href="aktiviteter.html">Aktiviteter</a>
            <a href="efterfesten.html">Efterfesten</a>
        </div>
    </nav>

    <div class="content-container">
        <!-- Rubriksektion -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Lagregister</h1>
            <p class="text-lg text-gray-600">En översikt över alla deltagande lag i cupen.</p>
        </header>

        <!-- Gruppfilterknappar sektion -->
        <div id="group-filter-buttons" class="group-filter-buttons-container">
            <!-- Knappar kommer att fyllas i av JS -->
            <div class="text-center text-gray-500 p-2">Laddar filterknappar...</div>
        </div>

        <!-- Laglistningssektion -->
        <div id="team-list">
            <div class="text-center text-gray-500 p-8 col-span-full">Laddar lagdata...</div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer class="footer">
        <img src="https://i.imgur.com/9q8c3ab.png" alt="Cup Footer Logo" class="footer-logo">
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed for lagregister.html');

            // !!! VIKTIGT: DATAKÄLLOR !!!
            // teamsCsvUrl: Denna URL pekar på ditt Google Sheet för laginformation (PUB_TEAMINFO).
            // Se till att ditt Google Sheet är publicerat som "Comma-separated values (.csv)".
            // Guide: https://support.google.com/docs/answer/183950?hl=en (Välj "Kommaavgränsade värden (.csv)")
            const teamsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=213368947&single=true&output=csv';

            const teamListDiv = document.getElementById('team-list');
            const groupFilterButtonsContainer = document.getElementById('group-filter-buttons');

            let allTeams = []; // Lagrar rådata för lag
            let currentGroupFilter = 'All'; // Tillståndsvariabel för aktuellt filter

            /**
             * Hämtar CSV-data från den angivna URL:en.
             * Visar ett felmeddelande på sidan om hämtningen misslyckas.
             * @param {string} url URL:en till CSV-filen.
             * @returns {Promise<string>} Ett löfte som löser med den avkodade CSV-texten.
             */
            async function fetchCsvData(url) {
                console.log(`Attempting to fetch CSV from: ${url}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorMsg = `HTTP Error! status: ${response.status} fetching ${url}. Kontrollera att Google Sheet är publicerat korrekt som CSV.`;
                        console.error(errorMsg);
                        teamListDiv.innerHTML = `<div class="text-center text-red-600 font-bold p-8 col-span-full">${errorMsg}</div>`;
                        throw new Error(errorMsg);
                    }
                    console.log(`Successfully fetched CSV from: ${url}`);
                    return await response.text();
                } catch (error) {
                    console.error('Fel vid hämtning av CSV-data från:', url, error);
                    teamListDiv.innerHTML = `<div class="text-center text-red-600 font-bold p-8 col-span-full">Nätverksfel eller fel vid laddning av lagdata. Kontrollera din internetanslutning och Google Sheet URL.</div>`;
                    throw error;
                }
            }

            /**
             * En robust CSV-parserfunktion som hanterar fält med kommatecken och citationstecken.
             * Förutsätter att fält som innehåller kommatecken är omslutna av dubbla citationstecken.
             * Hanterar även dubbla citationstecken inom citerade fält (genom att fördubbla dem, t.ex. "He said ""Hello""").
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Array<string>>} En array av rader, där varje rad är en array av strängvärden.
             */
            function parseRobustCsv(csvText) {
                const rows = [];
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) { // Tom CSV eller endast rader med mellanslag
                    return [];
                }

                // Bearbeta dataraderna (hoppa över rubrikraden för intern parsning)
                for (let i = 0; i < lines.length; i++) { // Loopar över alla rader, inklusive den första raden som rubriker
                    const line = lines[i];
                    const values = [];
                    let inQuote = false;
                    let currentField = '';

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const nextChar = line[j + 1];

                        if (char === '"') {
                            if (inQuote && nextChar === '"') { // Hantera dubbla citationstecken inuti ett citerat fält ("" blir ")
                                currentField += char;
                                j++; // Hoppa över nästa citationstecken
                            } else {
                                inQuote = !inQuote; // Växla in/ut ur citerat läge
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField.trim()); // Lägg till det sista fältet på raden
                    rows.push(values);
                }
                console.log(`Parsed ${rows.length - 1} data rows.`);
                return rows.slice(1); // Returnera alla rader utom rubrikraden
            }
            /**
             * NEW: Helper function to assign a color class based on group name.
             * @param {string} groupName The name of the group (e.g., "A", "B").
             * @returns {string} Tailwind CSS class for background and text color.
             */
            function getGroupColorClass(groupName) {
                if (!groupName || groupName === 'N/A') return 'group-default';
                const group = groupName.toUpperCase();
                if (group.includes('A')) return 'group-a';
                if (group.includes('B')) return 'group-b';
                if (group.includes('C')) return 'group-c';
                if (group.includes('D')) return 'group-d';
                // Add more cases if you have more than 4 groups with specific colors
                return 'group-default'; // Fallback
            }
            /**
             * Parsar CSV-text till en array av lagobjekt.
             * Förutsatt kolumnordning (viktigt!):
             * teamName|logo|captainName|group|teamDescription|teamStyle|secretWeapon|highlightOps|groupThreat|teamExp|celebration|motto|playersRaw|sponsor|sponsorLogo
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Object>} En array av lagobjekt.
             */
            function parseTeamsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) {
                    console.warn("Teams CSV är tom eller parsning resulterade i ingen data.");
                    return [];
                }
                const teams = [];
                const expectedColumns = 15;

                rawRows.forEach((values, index) => {
                    if (values.length > 0) { // Process only if row is not completely empty
                        const team = {
                            teamName: values[0]?.trim() || 'N/A',
                            logo: (values[1] && isValidImageUrl(values[1].trim())) ? values[1].trim() : 'https://placehold.co/70x70/aabbcc/ffffff?text=Logo',
                            captainName: values[2]?.trim() || 'N/A',
                            group: values[3]?.trim() || 'N/A',
                            teamDescription: values[4]?.trim() || 'Ingen beskrivning tillgänglig.', // For hub
                            teamStyle: values[5]?.trim() || 'N/A',
                            // secretWeapon etc. can be added if needed for the card, otherwise N/A for now
                            motto: values[11]?.trim() || 'N/A',
                            playersRaw: values[12]?.trim() || '',
                            shortDescription: values[13]?.trim() || '', // New field
                            sponsorInfoRaw: values[14]?.trim() || 'N/A', // Combined sponsor field
                        };

                        // Fallback for shortDescription
                        if (!team.shortDescription || team.shortDescription.toLowerCase() === 'n/a') {
                            if (team.teamDescription && team.teamDescription.toLowerCase() !== 'n/a') {
                                team.shortDescription = team.teamDescription.substring(0, 100); // Truncate long desc
                                if (team.teamDescription.length > 100) team.shortDescription += "...";
                            } else {
                                team.shortDescription = "Mer information kommer snart.";
                            }
                        }

                        // Parse sponsorInfoRaw
                        team.sponsorName = 'N/A';
                        team.sponsorLogoUrl = null;
                        if (team.sponsorInfoRaw && team.sponsorInfoRaw.toLowerCase() !== 'n/a') {
                            const parts = team.sponsorInfoRaw.split(';');
                            team.sponsorName = parts[0]?.trim() || 'N/A';
                            if (parts.length > 1 && parts[1]?.trim() && isValidImageUrl(parts[1].trim())) {
                                team.sponsorLogoUrl = parts[1].trim();
                            }
                        }

                        teams.push(team);

                        if (values.length < expectedColumns) { // Warn if not enough columns
                            console.warn(`[TEAMS CSV PARSE WARNING] Rad ${index + 2}: Förväntade ${expectedColumns} kolumner, men hittade ${values.length}. Rad: "${values.join(' | ')}"`);
                        }
                    }
                });
                return teams;
            }


            /**
             * Kontrollerar om en URL ser ut som en giltig bild-URL.
             * @param {string} url
             * @returns {boolean}
             */
            function isValidImageUrl(url) {
                return (url && (url.startsWith('http://') || url.startsWith('https://')) &&
                    (/\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url)));
            }

            /**
             * Fyller gruppfilterknapparna baserat på unika grupper från lagdatan.
             */
            function populateGroupFilterButtons() {
                const uniqueGroups = new Set(allTeams.map(team => team.group).filter(g => g && g !== 'N/A'));
                const sortedGroups = Array.from(uniqueGroups).sort();

                groupFilterButtonsContainer.innerHTML = ''; // Rensa laddningsmeddelandet

                // Lägg till "Alla" -knapp
                const allButton = document.createElement('button');
                allButton.className = 'group-filter-button active'; // Standard aktiv
                allButton.textContent = 'Alla Grupper';
                allButton.addEventListener('click', () => {
                    currentGroupFilter = 'All';
                    renderTeams();
                    activateButton(allButton);
                });
                groupFilterButtonsContainer.appendChild(allButton);

                // Lägg till knappar för varje unik grupp
                sortedGroups.forEach(group => {
                    const button = document.createElement('button');
                    button.className = 'group-filter-button';
                    button.textContent = `Grupp ${group}`;
                    button.addEventListener('click', () => {
                        currentGroupFilter = group;
                        renderTeams();
                        activateButton(button);
                    });
                    groupFilterButtonsContainer.appendChild(button);
                });
                console.log('Gruppfilterknappar har fyllts i.');
            }

            /**
             * Aktiverar den klickade knappen och avaktiverar andra.
             * @param {HTMLElement} activeButton Knappen som ska aktiveras.
             */
            function activateButton(activeButton) {
                document.querySelectorAll('.group-filter-button').forEach(button => {
                    button.classList.remove('active');
                });
                activeButton.classList.add('active');
            }

            /**
             * Rendrar laglistan baserat på aktuellt filter.
             */
            function renderTeams() {
                console.log('renderTeams kallad med filter:', currentGroupFilter);
                teamListDiv.innerHTML = '';

                const filteredTeams = currentGroupFilter === 'All'
                    ? allTeams
                    : allTeams.filter(team => team.group === currentGroupFilter);

                if (filteredTeams.length === 0) {
                    teamListDiv.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Inga lag att visa för ${currentGroupFilter === 'All' ? 'alla grupper' : 'Grupp ' + currentGroupFilter}.</div>`;
                    return;
                }

                filteredTeams.sort((a, b) => a.teamName.localeCompare(b.teamName));

                filteredTeams.forEach(team => {
                    const teamListItem = document.createElement('div');
                    teamListItem.className = 'team-list-item';

                    const groupColorClass = getGroupColorClass(team.group);
                    const numPlayers = team.playersRaw.split(',').filter(player => player.trim() !== '').length || 0;

                    const hubLink = `laghub.html?team=${encodeURIComponent(team.teamName)}`;

                    // Short description handling
                    let displayShortDescription = team.shortDescription;
                    const shortDescMaxLength = 70; // Max chars before "read more" hint
                    let readMoreHtml = "";
                    if (displayShortDescription.length > shortDescMaxLength) {
                        displayShortDescription = displayShortDescription.substring(0, shortDescMaxLength) + "... ";
                        readMoreHtml = `<a href="${hubLink}" class="read-more-link">läs mer</a>`;
                    }


                    // Row 3: Sponsor & Hub Link content
                    let row3Content = '';
                    const hasSponsor = team.sponsorName && team.sponsorName.toLowerCase() !== 'n/a';

                    if (hasSponsor) {
                        row3Content = `
                            <div class="sponsor-info-card">
                                ${team.sponsorLogoUrl ? `<img src="${team.sponsorLogoUrl}" alt="${team.sponsorName} Logo" class="sponsor-logo-small-card" onerror="this.style.display='none';">` : ''}
                                <span>${team.sponsorName}</span>
                            </div>
                            <a href="${hubLink}" class="team-hub-link-card">Visa Lag-Hubb</a>
                        `;
                    } else {
                        row3Content = `
                            <a href="${hubLink}" class="team-hub-link-card full-width">Visa Lag-Hubb</a>
                        `;
                    }

                    teamListItem.innerHTML = `
                        <!-- Row 1: Logo/Group + Name/Captain -->
                        <div class="team-card-row1">
                            <div class="team-card-row1-left">
                                <img src="${team.logo}" alt="${team.teamName} Logo" class="team-logo-card" onerror="this.onerror=null; this.src='https://placehold.co/70x70/aabbcc/ffffff?text=Logo';">
                                <span class="team-list-group-card ${groupColorClass}">
                                    ${team.group !== 'N/A' ? 'Grupp ' + team.group : 'Okänd Grupp'}
                                </span>
                            </div>
                            <div class="team-card-row1-right">
                                <h2 class="team-name-card">${team.teamName}</h2>
                                <p class="team-captain-card">Lagkapten: ${team.captainName || 'N/A'}</p>
                            </div>
                        </div>

                        <!-- Row 2: Info - Players, Style, Motto, ShortDesc -->
                        <div class="team-card-row2">
                            <p><strong>Antal spelare:</strong> ${numPlayers}</p>
                            ${team.teamStyle && team.teamStyle.toLowerCase() !== 'n/a' ? `<p><strong>Spelstil:</strong> ${team.teamStyle}</p>` : ''}
                            ${team.motto && team.motto.toLowerCase() !== 'n/a' ? `<p><strong>Motto:</strong> "${team.motto}"</p>` : ''}
                            <p class="short-description-card">${displayShortDescription}${readMoreHtml}</p>
                        </div>

                        <!-- Row 3: Sponsor / Hub Link -->
                        <div class="team-card-row3">
                            ${row3Content}
                        </div>
                    `;
                    teamListDiv.appendChild(teamListItem);
                });
            }

            // getTeamLogo is not needed here as team.logo is directly used.

            async function initializeTeamRegister() {
                // ... (initial loading messages remain)
                console.log('initializeTeamRegister kallad.');
                teamListDiv.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Laddar lagdata...</div>`;
                groupFilterButtonsContainer.innerHTML = `<div class="text-center text-gray-500 p-2">Laddar filterknappar...</div>`;

                try {
                    console.time('Hämtar Lag CSV');
                    const teamsCsvText = await fetchCsvData(teamsCsvUrl);
                    allTeams = parseTeamsCsv(teamsCsvText); // Uses the updated parser
                    console.timeEnd('Hämtar Lag CSV');
                    console.log('allTeams laddade:', allTeams.length, 'lag');

                    populateGroupFilterButtons();
                    renderTeams(); // Uses the updated renderer
                    console.log('Lagregistret initialiserat och renderat framgångsrikt.');
                } catch (error) {
                    console.error("Felsökning: Ett fel uppstod vid initialisering av lagregistret.", error);
                }
            }

            initializeTeamRegister();
        });
    </script>
</body>

</html>