<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelarregister</title>
    <!-- Tailwind CSS CDN för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Ljusgrå bakgrund */
            min-height: 100vh;
            /* Säkerställer att bakgrunden täcker hela sidan */
            display: flex;
            flex-direction: column;
            /* För att navbaren ska ligga överst */
            align-items: center;
            justify-content: flex-start;
            /* Justera för navbar */
            padding: 0;
            /* Ta bort padding från body */
        }

        .navbar {
            width: 100%;
            background-color: #1a202c;
            /* Mörk bakgrund för navbar */
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            /* Kvar på toppen vid scroll */
            top: 0;
            z-index: 1000;
            /* Säkerställ att den ligger över annat innehåll */
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            /* rounded-md */
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
        }

        .navbar a:hover {
            background-color: #4a5568;
            /* Mörkare grå vid hover */
        }

        .content-container {
            max-width: 960px;
            /* max-w-4xl är ca 960px */
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            /* Justerad padding */
            margin-top: 2rem;
            /* Marginal från navbar */
            margin-bottom: 2rem;
        }

        /* Team-kort för spelarregister, oförändrat */
        .team-card-player {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.2s ease-in-out;
        }

        .team-card-player:hover {
            transform: translateY(-3px);
        }

        /* Spelarförteckningen (ul) för ett team */
        .player-list {
            list-style: none;
            padding-left: 0;
        }

        /* Spelarobjekt (li) för expandering */
        .player-item-expandable {
            background-color: #f7fafc;
            /* Lättare bakgrund för varje spelare */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            /* Mer padding för klickbar yta */
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            /* För att dölja detaljer när de är kollapsade */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .player-item-expandable:hover {
            background-color: #edf2f7;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .player-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-name-summary {
            font-weight: 600;
            /* semi-bold */
            color: #2d3748;
            flex-grow: 1;
            /* Låter namnet ta plats */
        }

        .player-summary-info {
            font-size: 0.9rem;
            color: #6b7280;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        .expand-toggle {
            font-size: 1.5rem;
            /* Storlek på +/- ikon */
            font-weight: 600;
            color: #4a5568;
            margin-left: 1rem;
            transition: transform 0.3s ease-in-out;
        }

        .player-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            padding-top: 0;
            /* Initial padding */
        }

        .player-details-content.expanded {
            max-height: 800px;
            /* Tillräckligt stor för att visa alla spelardetaljer, justerat för nya fält */
            padding-top: 1rem;
            /* Lägg till padding när expanderad */
        }

        .detail-item {
            margin-bottom: 0.4rem;
            font-size: 0.95rem;
            color: #4a5568;
        }

        .detail-item strong {
            color: #1a202c;
            margin-right: 0.4rem;
        }

        /* Responsive justeringar */
        @media (max-width: 640px) {

            /* För mobil (sm breakpoint) */
            .navbar-links {
                flex-direction: column;
                align-items: center;
            }

            .navbar a {
                width: 100%;
                text-align: center;
                margin-bottom: 0.5rem;
            }

            .player-summary {
                flex-wrap: wrap;
                justify-content: center;
                text-align: center;
            }

            .player-name-summary,
            .player-summary-info {
                width: 100%;
                margin-left: 0;
                margin-bottom: 0.5rem;
            }

            .player-role-icon {
                margin-right: 0.2rem;
            }

            .expand-toggle {
                position: absolute;
                top: 0.75rem;
                /* Justera positionen */
                right: 1rem;
                margin-left: 0;
            }

            .player-item-expandable {
                position: relative;
                /* För positionering av toggle */
                padding-right: 3rem;
                /* Ge plats för toggle */
            }
        }
    </style>
</head>

<body class="flex flex-col">
    <!-- Global Navigationsmeny -->
    <nav class="navbar">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <div class="font-bold text-xl mb-2 sm:mb-0">Arboga Stad Cup</div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 navbar-links">
                <a href="index.html">Startsida</a>
                <a href="fotbollsschema.html">Spelschema</a>
                <a href="lagregister.html">Lagregister</a>
                <a href="spelaregister.html">Spelarregister</a>
                <a href="tabeller.html">Tabeller</a>
                <a href="sponsorer.html">Samarbetspartners</a>
                <a href="aktiviteter.html">Aktiviteter</a>
            </div>
        </div>
    </nav>

    <div class="content-container">
        <!-- Rubriksektion -->
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Spelarregister</h1>
            <p class="text-lg text-gray-600">Detaljerad översikt över alla spelare.</p>
        </header>

        <!-- Spelarlistningssektion -->
        <div id="player-list-container" class="flex flex-col gap-6">
            <div class="text-center text-gray-500 p-8 col-span-full">Laddar spelarregister...</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // !!! VIKTIGT !!!
            // Denna URL pekar nu på din dedikerade PUB_PLAYERINFO Google Sheet.
            const playerCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=1028240933&single=true&output=csv';
            // Denna URL pekar nu på din dedikerade PLAYER_STATS Google Sheet.
            const playerStatsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=1809976994&single=true&output=csv';

            const playerListContainer = document.getElementById('player-list-container');
            let allPlayers = []; // Lagrar rådata från PUB_PLAYERINFO CSV
            let allPlayerStats = []; // Lagrar rådata från PLAYER_STATS CSV

            /**
             * Hämtar CSV-data från den angivna URL:en.
             * @param {string} url URL:en till CSV-filen.
             * @returns {Promise<string>} Ett löfte som löser med CSV-texten.
             */
            async function fetchCsvData(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP Error! status: ${response.status}`);
                    }
                    return await response.text();
                } catch (error) {
                    console.error('Fel vid hämtning av CSV-data från:', url, error);
                    playerListContainer.innerHTML = `<div class="text-center text-red-600 font-bold col-span-full p-4">
                                                        Fel vid laddning av spelarregister. <br>
                                                        Se till att du har publicerat dina Google Sheets med spelardata till webben som CSV
                                                        och att URL:erna i koden är korrekta.
                                                        <br>
                                                        <a href="https://support.google.com/docs/answer/183950?hl=en" target="_blank" class="text-blue-600 hover:underline">Hur du publicerar Google Sheet till webben (Google Support)</a>
                                                        <p class="mt-2 text-sm text-gray-700">Om data visas som "undefined", kontrollera att dina Google Sheets är korrekt publicerade som *Comma-separated values (.csv)* och att ALLA kolumner matchar den förväntade ordningen i koden.</p>
                                                    </div>`;
                    throw error;
                }
            }

            /**
             * En robust CSV-parserfunktion som hanterar fält med kommatecken och citationstecken.
             * Förutsätter att fält som innehåller kommatecken är omslutna av dubbla citationstecken.
             * Hanterar även dubbla citationstecken inom citerade fält (genom att fördubbla dem, t.ex. "He said ""Hello""").
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Array<string>>} En array av rader, där varje rad är en array av strängvärden.
             */
            function parseRobustCsv(csvText) {
                const rows = [];
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) { // Tom CSV eller bara whitespace-rader
                    return [];
                }

                // Bearbeta dataraderna (hoppa över rubrikraden för intern parsning)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const values = [];
                    let inQuote = false;
                    let currentField = '';

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const nextChar = line[j + 1];

                        if (char === '"') {
                            if (inQuote && nextChar === '"') { // Hantera dubbla citationstecken inuti ett citerat fält ("" blir ")
                                currentField += char;
                                j++; // Hoppa över nästa citationstecken
                            } else {
                                inQuote = !inQuote; // Växla in/ut ur citerat läge
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField.trim()); // Lägg till det sista fältet på raden
                    rows.push(values);
                }
                return rows.slice(1); // Returnera alla rader utom rubrikraden
            }

            /**
             * Parsar CSV-text till en array av spelarobjekt från PUB_PLAYERINFO.
             * VIKTIGT: Denna funktion förväntar sig kolumnerna i DENNA SPECIFIKA ORDNING:
             * UID|NAME|KAPTEN|ROLL|LAG|SPONSOR|NR|GROUP|NICKNAME|NICKNAME_EXT|CUP_EXPERIENCE|FOOTBALL_EXPERIENCE|FAVORITE_PLAYER_AND_TEAM|OUTSIDE_FOOTBALL|UNEXPECTED_ABOUT_YOU|GAME_RIITUAL|CUP_CRUSH|EGO_DEATH_TUNNEL|BLAME_IF_LOSE|CELEBRATE_FINAL|STATS_YELLOW|STATS_RED|STATS_GOALS
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Object>} En array av spelarobjekt.
             */
            function parsePlayersCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) return [];

                const players = [];
                // Nya headers för PUB_PLAYERINFO
                const headers = [
                    'uid', 'name', 'isCaptainRaw', 'role', 'team', 'sponsor', 'number', 'group',
                    'nickname', 'nicknameExt', 'cupExperience', 'footballExperience',
                    'favoritePlayerAndTeam', 'outsideFootball', 'unexpectedAboutYou',
                    'gameRitual', 'cupCrush', 'egoDeathTunnel', 'blameIfLose',
                    'celebrateFinal', 'statsYellow', 'statsRed', 'statsGoals' // STATS_GOALS är den sista kolumnen nu
                ];

                rawRows.forEach((values, index) => { // Börja från index 0 eftersom parseRobustCsv redan hanterat rubrikraden
                    if (values.length >= headers.length) {
                        const player = {};
                        headers.forEach((header, colIndex) => {
                            player[header] = values[colIndex] ? values[colIndex].trim() : 'N/A';
                        });
                        player.isCaptain = player.isCaptainRaw.toLowerCase() === 'k' ||
                            player.isCaptainRaw.toLowerCase() === 'kapten' ||
                            player.isCaptainRaw.toLowerCase() === 'ja';
                        player.isGoalkeeper = player.role.toLowerCase() === 'mv' ||
                            player.role.toLowerCase() === 'keeper' ||
                            player.role.toLowerCase() === 'målvakt';
                        players.push(player);
                    } else {
                        console.warn(`Hoppar över felaktig spelarrad ${index + 2}: Inte tillräckligt med kolumner (förväntade ${headers.length}, hittade ${values.length}).`);
                    }
                });
                return players;
            }

            /**
             * Parsar CSV-text till en array av spelarstatsobjekt från PLAYER_STATS.
             * VIKTIGT: Denna funktion förväntar sig kolumnerna i DENNA SPECIFIKA ORDNING:
             * UID|Lag|Namn|Tröjnummer|Antal mål|Gult kort|Rött kort
             * @param {string} csvText CSV-innehållet som en sträng.
             * @returns {Array<Object>} En array av spelarstatsobjekt.
             */
            function parsePlayerStatsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) return [];

                const stats = [];
                const headers = ['uid', 'team', 'name', 'jerseyNumber', 'goals', 'yellowCards', 'redCards'];

                rawRows.forEach((values, index) => {
                    if (values.length >= headers.length) {
                        const playerStats = {};
                        headers.forEach((header, colIndex) => {
                            let value = values[colIndex] ? values[colIndex].trim() : 'N/A';
                            if (['goals', 'yellowCards', 'redCards'].includes(header)) {
                                playerStats[header] = parseInt(value) || 0; // Parse as integer, default to 0
                            } else {
                                playerStats[header] = value;
                            }
                        });
                        stats.push(playerStats);
                    } else {
                        console.warn(`Hoppar över felaktig spelarstatistikrad ${index + 2}: Inte tillräckligt med kolumner (förväntade ${headers.length}, hittade ${values.length}).`);
                    }
                });
                return stats;
            }


            /**
             * Renderar spelarregistret, grupperat efter lag.
             */
            function renderPlayerRegister() {
                playerListContainer.innerHTML = ''; // Rensa tidigare innehåll

                if (allPlayers.length === 0) {
                    playerListContainer.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">Inga spelare hittades i registret.</div>`;
                    return;
                }

                // Gruppera spelare efter lag
                const groupedByTeam = allPlayers.reduce((acc, player) => {
                    const team = player.team || 'Okänt Lag';
                    if (!acc[team]) acc[team] = [];
                    acc[team].push(player);
                    return acc;
                }, {});

                // Sortera lag alfabetiskt
                const sortedTeams = Object.keys(groupedByTeam).sort();

                sortedTeams.forEach(teamName => {
                    const teamPlayers = groupedByTeam[teamName];
                    // Hitta en representativ spelare för att få gruppnamnet för lagkortet
                    const representativePlayer = teamPlayers.find(p => p.group && p.group !== 'N/A') || teamPlayers[0];
                    const groupName = representativePlayer ? representativePlayer.group : 'N/A';

                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card-player';
                    teamCard.innerHTML = `
                        <div class="flex justify-between items-center cursor-pointer team-header" data-target="#players-of-${teamName.replace(/\s+/g, '-')}" role="button" tabindex="0">
                            <h3 class="text-xl font-bold text-gray-900">${teamName} <span class="text-gray-500 text-base font-normal">(Grupp: ${groupName}, ${teamPlayers.length} spelare)</span></h3>
                            <span class="expand-toggle text-gray-500 text-2xl font-semibold">+</span>
                        </div>
                        <div id="players-of-${teamName.replace(/\s+/g, '-')}" class="player-list-section mt-4">
                            <ul class="player-list">
                                ${teamPlayers.map(player => {
                        // Hämta statistik för spelaren från allPlayerStats
                        const playerStat = allPlayerStats.find(stat =>
                            stat.name === player.name && stat.team === player.team
                        );
                        // Prioritera stats från PLAYER_STATS, annars fallback till PUB_PLAYERINFO
                        const goals = playerStat ? playerStat.goals : (player.statsGoals !== 'N/A' ? parseInt(player.statsGoals) || 0 : 0);
                        const yellowCards = playerStat ? playerStat.yellowCards : (player.statsYellow !== 'N/A' ? parseInt(player.statsYellow) || 0 : 0);
                        const redCards = playerStat ? playerStat.redCards : (player.statsRed !== 'N/A' ? parseInt(player.statsRed) || 0 : 0);

                        return `
                                    <li class="player-item-expandable" data-target="#player-details-${player.team.replace(/\s+/g, '-')}-${player.name.replace(/\s+/g, '-')}" role="button" tabindex="0">
                                        <div class="player-summary">
                                            ${player.isCaptain ? '<span class="player-role-icon" title="Kapten">👑</span>' : ''}
                                            ${player.isGoalkeeper ? '<span class="player-role-icon" title="Målvakt">🧤</span>' : ''}
                                            <span class="player-name-summary">${player.name || 'N/A'}</span>
                                            ${player.number && player.number !== 'N/A' ? `<span class="player-summary-info">Nr: ${player.number}</span>` : ''}
                                            <span class="expand-toggle">+</span>
                                        </div>
                                        <div id="player-details-${player.team.replace(/\s+/g, '-')}-${player.name.replace(/\s+/g, '-')}" class="player-details-content">
                                            ${player.role && player.role !== 'N/A' && !player.isGoalkeeper && !player.isCaptain ? `<p class="detail-item"><strong>Roll:</strong> ${player.role}</p>` : ''}
                                            ${player.nickname && player.nickname !== 'N/A' ? `<p class="detail-item"><strong>Smeknamn:</strong> ${player.nickname}</p>` : ''}
                                            ${player.nicknameExt && player.nicknameExt !== 'N/A' ? `<p class="detail-item"><strong>Utökad Smeknamn:</strong> ${player.nicknameExt}</p>` : ''}
                                            ${player.cupExperience && player.cupExperience !== 'N/A' ? `<p class="detail-item"><strong>Cuperfarenhet:</strong> ${player.cupExperience}</p>` : ''}
                                            ${player.footballExperience && player.footballExperience !== 'N/A' ? `<p class="detail-item"><strong>Fotbollserfarenhet:</strong> ${player.footballExperience}</p>` : ''}
                                            ${player.favoritePlayerAndTeam && player.favoritePlayerAndTeam !== 'N/A' ? `<p class="detail-item"><strong>Favoritspelare/Lag:</strong> ${player.favoritePlayerAndTeam}</p>` : ''}
                                            ${player.outsideFootball && player.outsideFootball !== 'N/A' ? `<p class="detail-item"><strong>Utanför fotbollen:</strong> ${player.outsideFootball}</p>` : ''}
                                            ${player.unexpectedAboutYou && player.unexpectedAboutYou !== 'N/A' ? `<p class="detail-item"><strong>Oväntat om dig:</strong> ${player.unexpectedAboutYou}</p>` : ''}
                                            ${player.gameRitual && player.gameRitual !== 'N/A' ? `<p class="detail-item"><strong>Matchritual:</strong> ${player.gameRitual}</p>` : ''}
                                            ${player.cupCrush && player.cupCrush !== 'N/A' ? `<p class="detail-item"><strong>Cup Crush:</strong> ${player.cupCrush}</p>` : ''}
                                            ${player.egoDeathTunnel && player.egoDeathTunnel !== 'N/A' ? `<p class="detail-item"><strong>Ego Death Tunnel:</strong> ${player.egoDeathTunnel}</p>` : ''}
                                            ${player.blameIfLose && player.blameIfLose !== 'N/A' ? `<p class="detail-item"><strong>Skuld vid förlust:</strong> ${player.blameIfLose}</p>` : ''}
                                            ${player.celebrateFinal && player.celebrateFinal !== 'N/A' ? `<p class="detail-item"><strong>Fira final:</strong> ${player.celebrateFinal}</p>` : ''}
                                            <p class="detail-item"><strong>Mål:</strong> ${goals}</p>
                                            <p class="detail-item"><strong>Gula kort:</strong> ${yellowCards}</p>
                                            <p class="detail-item"><strong>Röda kort:</strong> ${redCards}</p>
                                        </div>
                                    </li>
                                `}).join('')}
                            </ul>
                        </div>
                    `;
                    playerListContainer.appendChild(teamCard);
                });

                // Lägg till eventlyssnare för expandering/kollaps av lag
                document.querySelectorAll('.team-header').forEach(header => {
                    header.addEventListener('click', (event) => {
                        const targetId = header.dataset.target;
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            targetElement.classList.toggle('expanded');
                            const toggleIcon = header.querySelector('.expand-toggle');
                            toggleIcon.textContent = targetElement.classList.contains('expanded') ? '−' : '+';
                        }
                    });
                });

                // Lägg till eventlyssnare för expandering/kollaps av spelare
                document.querySelectorAll('.player-item-expandable').forEach(playerItem => {
                    playerItem.addEventListener('click', (event) => {
                        const targetId = playerItem.dataset.target;
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            targetElement.classList.toggle('expanded');
                            const toggleIcon = playerItem.querySelector('.expand-toggle');
                            toggleIcon.textContent = targetElement.classList.contains('expanded') ? '−' : '+';
                        }
                    });
                });
            }

            // Initial laddning av data
            async function initializePlayerRegister() {
                try {
                    const [playerCsvText, playerStatsCsvText] = await Promise.all([
                        fetchCsvData(playerCsvUrl),
                        fetchCsvData(playerStatsCsvUrl)
                    ]);

                    allPlayers = parsePlayersCsv(playerCsvText);
                    allPlayerStats = parsePlayerStatsCsv(playerStatsCsvText); // Parse player stats data

                    renderPlayerRegister();
                } catch (error) {
                    console.error("Felsökning: Ett fel uppstod vid initialisering av spelarregistret.", error);
                    // Felmeddelande visas redan av fetchCsvData
                }
            }

            initializePlayerRegister();
        });
    </script>
</body>

</html>