<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arboga Stad Cup - Tabeller</title>
    <!-- Tailwind CSS CDN för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS83LWSY7E"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-YS83LWSY7E');
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 0;
        }

        .navbar {
            width: 100%;
            background-color: #1a202c;
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .navbar-home-logo {
            height: 2.5rem;
            margin-right: 1.5rem;
            cursor: pointer;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
        }

        .navbar-home-logo:hover {
            transform: scale(1.05);
        }

        .navbar-links-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex-grow: 1;
            justify-content: center;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            white-space: nowrap;
        }

        .navbar a:hover {
            background-color: #4a5568;
        }

        .content-container {
            max-width: 960px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            flex-grow: 1;
        }

        .section-heading {
            font-size: 2.25rem;
            font-weight: 800;
            color: #1a202c;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .group-heading {
            font-size: 2rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .table-container {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .standings-table,
        .results-table,
        .top-scorer-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            line-height: 1.5;
            table-layout: fixed;
            /* Helps with consistent column widths */
        }

        .standings-table th,
        .standings-table td,
        .results-table th,
        .results-table td,
        .top-scorer-table th,
        .top-scorer-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            word-break: break-word;
        }

        .standings-table th,
        .results-table th,
        .top-scorer-table th {
            background-color: #f0f4f8;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        .standings-table tbody tr:hover,
        .results-table tbody tr:hover,
        .top-scorer-table tbody tr:hover {
            background-color: #f7fafc;
        }

        .team-cell {
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .team-logo-small {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            object-fit: cover;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .points-cell,
        .goals-cell {
            font-weight: 700;
            color: #3b82f6;
        }

        /* DESKTOP Column Widths */
        /* Logo */
        .standings-table th:nth-child(1),
        .standings-table td:nth-child(1) {
            width: 10%;
        }

        /* Lag */
        .standings-table th:nth-child(2),
        .standings-table td:nth-child(2) {
            width: 15%;
        }

        /* M */
        .standings-table th:nth-child(3),
        .standings-table td:nth-child(3) {
            width: 7%;
        }

        /* V */
        .standings-table th:nth-child(4),
        .standings-table td:nth-child(4) {
            width: 7%;
        }

        /* O */
        .standings-table th:nth-child(5),
        .standings-table td:nth-child(5) {
            width: 7%;
        }

        /* F */
        .standings-table th:nth-child(6),
        .standings-table td:nth-child(6) {
            width: 7%;
        }

        /* GM */
        .standings-table th:nth-child(7),
        .standings-table td:nth-child(7) {
            width: 7%;
        }

        /* IM */
        .standings-table th:nth-child(8),
        .standings-table td:nth-child(8) {
            width: 7%;
        }

        /* MS */
        .standings-table th:nth-child(9),
        .standings-table td:nth-child(9) {
            width: 7%;
        }

        /* P */
        .standings-table th:nth-child(10),
        .standings-table td:nth-child(10) {
            width: 7%;
        }

        /* Nästa */
        .standings-table th:nth-child(11),
        .standings-table td:nth-child(11) {
            width: 25%;
        }

        /* Matchid */
        .results-table th:nth-child(1),
        .results-table td:nth-child(1) {
            width: 5%;
        }

        /* Tid */
        .results-table th:nth-child(2),
        .results-table td:nth-child(2) {
            width: 15%;
        }

        /* Hemma */
        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            width: 20%;
        }

        /* Borta */
        .results-table th:nth-child(4),
        .results-table td:nth-child(4) {
            width: 20%;
        }

        /* Resultat */
        .results-table th:nth-child(5),
        .results-table td:nth-child(5) {
            width: 15%;
        }

        /* Anmärkning */
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
            display: none;
        }



        .top-scorer-table th:nth-child(1),
        .top-scorer-table td:nth-child(1) {
            width: 10%;
        }

        /* Rank */
        .top-scorer-table th:nth-child(2),
        .top-scorer-table td:nth-child(2) {
            width: 40%;
        }

        /* Namn */
        .top-scorer-table th:nth-child(3),
        .top-scorer-table td:nth-child(3) {
            width: 30%;
        }

        /* Lag */
        .top-scorer-table th:nth-child(4),
        .top-scorer-table td:nth-child(4) {
            width: 20%;
        }

        /* Mål */


        .qualified-teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        .qualified-team-card {
            background-color: #ebf8ff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            font-weight: 600;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }

        .footer {
            width: 100%;
            background-color: #1a202c;
            padding: 1.5rem;
            text-align: center;
            margin-top: auto;
        }

        .footer-logo {
            max-width: 100%;
            height: 6rem;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.25rem;
            background-color: #e2e8f0;
            color: #4a5568;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            flex-grow: 1;
            text-align: center;
            min-width: 100px;
        }

        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .tab-button:hover:not(.active) {
            background-color: #cbd5e0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tournament-bracket {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
        }

        .bracket-stages {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .bracket-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
            align-items: center;
        }

        .bracket-stage:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .match-card {
            background-color: #f0f4f8;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
            width: 100%;
            max-width: 250px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
        }

        .match-card .team-name {
            font-weight: 600;
            color: #2d3748;
            padding: 0.2rem 0;
        }

        .match-card .score {
            font-weight: 700;
            color: #3b82f6;
            margin-top: 0.25rem;
            font-size: 1.1rem;
        }

        .match-card .vs-separator {
            font-size: 0.8rem;
            color: #718096;
            margin: -0.2rem 0;
        }

        .winner-display {
            background-color: #d6e8ff;
            border: 2px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
            font-size: 1.6rem;
            font-weight: 800;
            color: #1a202c;
            text-align: center;
            width: 100%;
            max-width: 300px;
        }

        .team-description-card {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .team-description-card.alt-bg {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }

        .team-description-card h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .bracket-stages {
                flex-direction: row;
                align-items: flex-start;
            }

            .bracket-stage {
                border-bottom: none;
                border-right: 1px solid #e2e8f0;
                padding-right: 2rem;
                padding-left: 2rem;
                margin-bottom: 0;
                justify-content: space-around;
                height: auto;
            }

            .bracket-stage:first-child {
                padding-left: 0;
            }

            .bracket-stage:last-child {
                border-right: none;
                padding-right: 0;
            }

            .bracket-stage:nth-child(2) {
                margin-top: 4rem;
                margin-bottom: 4rem;
            }

            .bracket-stage:nth-child(3) {
                margin-top: 8rem;
                margin-bottom: 8rem;
            }
        }

        @media (max-width: 640px) {

            /* --- MOBILE STYLES START --- */
            .navbar {
                padding: 0.75rem 1rem;
            }

            .navbar-home-logo {
                height: 2rem;
                margin-right: 1rem;
                margin-bottom: 0;
            }

            .navbar-links-wrapper {
                gap: 0.25rem;
            }

            .navbar a {
                padding: 0.4rem 0.6rem;
                font-size: 0.9rem;
            }

            .standings-table,
            .results-table,
            .top-scorer-table {
                font-size: 0.8rem;
            }

            .standings-table th,
            .standings-table td,
            .results-table th,
            .results-table td,
            .top-scorer-table th,
            .top-scorer-table td {
                padding: 0.6rem 0.3rem;
                vertical-align: middle;
                /* Better alignment */
            }

            .team-logo-small {
                width: 1.25rem;
                height: 1.25rem;
                margin-right: 0.3rem;
            }

            /* Span for team name text within .team-cell for nowrap and ellipsis */
            .team-cell .team-name-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-grow: 1;
                min-width: 0;
                /* Important for ellipsis in flex child */
            }

            /* Standings Table (.standings-table) - Mobile Column Visibility & Widths */
            /* Visible: Lag, M, V, O, F, MS, P */
            /* Hidden: GM(7), IM(8), Nästa(11) */
            .standings-table th:nth-child(7),
            .standings-table td:nth-child(7),
            /* GM */
            .standings-table th:nth-child(8),
            .standings-table td:nth-child(8),
            /* IM */
            .standings-table th:nth-child(11),
            .standings-table td:nth-child(11) {
                /* Nästa */
                display: none;
            }

            /* Logo */
            .standings-table th:nth-child(1),
            .standings-table td:nth-child(1) {
                width: 10%;
            }

            /* Lag */
            .standings-table th:nth-child(2),
            .standings-table td:nth-child(2) {
                width: 15%;
            }

            /* M */
            .standings-table th:nth-child(3),
            .standings-table td:nth-child(3),
            /* V */
            .standings-table th:nth-child(4),
            .standings-table td:nth-child(4),
            /* O */
            .standings-table th:nth-child(5),
            .standings-table td:nth-child(5) {
                width: 9%;
                text-align: center;
                white-space: nowrap;
            }

            /* F */
            .standings-table th:nth-child(6),
            .standings-table td:nth-child(6) {
                width: 9%;
                text-align: center;
                white-space: nowrap;
            }

            /* MS */
            .standings-table th:nth-child(9),
            .standings-table td:nth-child(9) {
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }

            /* P */
            .standings-table th:nth-child(10),
            .standings-table td:nth-child(10) {
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }


            /* Results Table (.results-table) - Mobile Column Visibility & Widths */
            .results-table th:nth-child(1),
            .results-table td:nth-child(1),
            /* Matchid */
            .results-table th:nth-child(2),
            .results-table td:nth-child(2),
            /* Tid */
            .results-table th:nth-child(6),
            .results-table td:nth-child(6) {
                /* Anmärkning */
                display: none;
            }

            .results-table th:nth-child(3),
            .results-table td:nth-child(3) {
                width: 40%;
            }

            /* Hemma */
            .results-table th:nth-child(4),
            .results-table td:nth-child(4) {
                width: 40%;
            }

            /* Borta */
            .results-table th:nth-child(5),
            .results-table td:nth-child(5) {
                width: 20%;
                text-align: center;
                white-space: nowrap;
            }

            /* Resultat */
            /* If Hemma/Borta use .team-cell, the .team-name-text style will apply if JS wraps the name in a span */


            /* Top Scorer Table (.top-scorer-table) - Mobile Column Visibility & Widths */
            /* Rank */
            .top-scorer-table th:nth-child(1),
            .top-scorer-table td:nth-child(1) {
                display: none;
            }

            /* Lag */
            .top-scorer-table th:nth-child(3),
            .top-scorer-table td:nth-child(3),
            /* {
                display: none;
            } */

            /* Namn */
            .top-scorer-table th:nth-child(2),
            .top-scorer-table td:nth-child(2) {
                width: 70%;
            }


            /* If Namn needs ellipsis: wrap in span in JS, add styles similar to .team-name-text */
            /* Mål */
            .top-scorer-table th:nth-child(4),
            .top-scorer-table td:nth-child(4) {
                width: 30%;
                text-align: center;
                white-space: nowrap;
            }


            /* If Lag column in top scorers used .team-cell, it would also need the JS span wrapping for .team-name-text */


            @media (max-width: 480px) {

                /* For very small screens */
                .tab-button {
                    width: 100%;
                    flex-grow: 0;
                }

                .tab-buttons {
                    gap: 0.5rem;
                }
            }

            /* --- MOBILE STYLES END --- */
        }
    </style>
</head>

<body class="flex flex-col">
    <!-- Global Navigationsmeny -->

    <nav class="navbar">
        <div class="navbar-links-wrapper">
            <a href="index.html">Startsida</a>
            <a href="fotbollsschema.html">Spelschema</a>
            <a href="lagregister.html">Lagen</a>
            <a href="tabeller.html">Tabell & resultat</a>
            <a href="Leaderboards.html">Rekord</a>
            <a href="sponsorer.html">Partners</a>
        </div>
    </nav>

    <div class="content-container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Resultat och Tabeller</h1>
        </header>

        <h2 class="section-heading">Grupptabeller</h2>
        <div class="tab-buttons" id="group-tab-buttons"></div>
        <div id="standings-tabs-content"></div>

        <h2 class="section-heading">Just nu klara för slutspel</h2>
        <div id="qualified-teams-list" class="table-container">
            <div class="text-center text-gray-500 p-4">Laddar kvalificerade lag...</div>
        </div>

        <h2 class="section-heading">Alla Matchresultat</h2>
        <div id="match-results-list" class="table-container">
            <div class="text-center text-gray-500 p-4">Laddar matchresultat...</div>
        </div>
    </div>

    <footer class="footer">
        <img src="https://i.imgur.com/9q8c3ab.png" alt="Cup Footer Logo" class="footer-logo">
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed for tabeller.html');

            const standingsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=1900542434&single=true&output=csv';
            const groupScheduleCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=894699500&single=true&output=csv';
            const teamsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA5hxt_CRmSr2oUS4azErMtLNn70vBLm-n8uHSK4RgpJNccOat05jV9F02iDF0ViM4dPzsVhrjWZ2O/pub?gid=213368947&single=true&output=csv';

            const standingsTabsContentDiv = document.getElementById('standings-tabs-content');
            const matchResultsListDiv = document.getElementById('match-results-list');
            const qualifiedTeamsListDiv = document.getElementById('qualified-teams-list');
            const groupTabButtonsDiv = document.getElementById('group-tab-buttons');

            let allStandingsData = [];
            let allGamesData = [];
            let allTeamsData = [];
            let availableGroups = [];

            async function fetchCsvData(url, errorDisplayElement, sectionName) {
                console.log(`Attempting to fetch CSV from: ${url} for ${sectionName}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorMessage = `Kunde inte ladda data för ${sectionName}. (HTTP Status: ${response.status})`;
                        console.error(errorMessage, url);
                        errorDisplayElement.innerHTML = `<div class="text-center text-red-600 font-bold p-4">${errorMessage}</div>`;
                        return '';
                    }
                    console.log(`Successfully fetched CSV from: ${url} for ${sectionName}`);
                    const decodedText = await response.text();
                    return decodedText;
                } catch (error) {
                    const errorMessage = `Nätverksfel vid laddning av data för ${sectionName}.`;
                    console.error(errorMessage, url, error);
                    errorDisplayElement.innerHTML = `<div class="text-center text-red-600 font-bold p-4">${errorMessage}</div>`;
                    return '';
                }
            }

            function parseRobustCsv(csvText) {
                const rows = [];
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const values = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const nextChar = line[j + 1];
                        if (char === '"') {
                            if (inQuote && nextChar === '"') { currentField += char; j++; }
                            else { inQuote = !inQuote; }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField.trim()); currentField = '';
                        } else { currentField += char; }
                    }
                    values.push(currentField.trim());
                    rows.push(values);
                }
                return rows.slice(1);
            }

            function parseStandingsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) { console.warn("Standings CSV är tom."); return []; }
                const standings = [];
                const headers = ['teamName', 'group', 'matchesPlayed', 'wins', 'draws', 'losses', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points', 'nextMatch', 'goalDifferencePerGame'];
                rawRows.forEach((values, index) => {
                    if (values.length >= headers.length) {
                        const entry = {};
                        headers.forEach((header, colIndex) => {
                            let value = values[colIndex] ? values[colIndex].trim() : 'N/A';
                            if (['matchesPlayed', 'wins', 'draws', 'losses', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points'].includes(header)) {
                                entry[header] = parseInt(value) || 0;
                            } else { entry[header] = value; }
                        });
                        standings.push(entry);
                    } else { console.warn(`Hoppar över tabellrad ${index + 2}. Rad: "${values.join(',')}"`); }
                });
                return standings;
            }

            function parseGroupScheduleCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) { console.warn("Group Schedule CSV är tom."); return []; }
                const games = [];
                const headers = ['matchId', 'time', 'team1', 'team2', 'venue', 'group', 'result', 'matchStatus'];
                rawRows.forEach((values, index) => {
                    if (values.length >= headers.length) {
                        const game = {};
                        headers.forEach((header, colIndex) => { game[header] = values[colIndex] ? values[colIndex].trim() : 'N/A'; });
                        games.push(game);
                    } else { console.warn(`Hoppar över schemarad ${index + 2}. Rad: "${values.join(',')}"`); }
                });
                return games;
            }

            function parseTeamsCsv(csvText) {
                const rawRows = parseRobustCsv(csvText);
                if (rawRows.length === 0) { console.warn("Teams CSV är tom."); return []; }
                const teams = [];
                const headersCount = 15;
                rawRows.forEach((values, index) => {
                    if (values.length >= headersCount) {
                        const team = {
                            teamName: values[0] ? values[0].trim() : 'N/A',
                            logo: (values[1] && isValidImageUrl(values[1])) ? values[1].trim() : 'https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo',
                            captainName: values[2] ? values[2].trim() : 'N/A',
                            group: values[3] ? values[3].trim() : 'N/A',
                            teamDescription: values[4] ? values[4].trim() : 'N/A',
                            teamStyle: values[5] ? values[5].trim() : 'N/A',
                            secretWeapon: values[6] ? values[6].trim() : 'N/A',
                            highlightOps: values[7] ? values[7].trim() : 'N/A',
                            groupThreat: values[8] ? values[8].trim() : 'N/A',
                            teamExp: values[9] ? values[9].trim() : 'N/A',
                            celebration: values[10] ? values[10].trim() : 'N/A',
                            motto: values[11] ? values[11].trim() : 'N/A',
                            playersRaw: values[12] ? values[12].trim() : '',
                            sponsor: values[13] ? values[13].trim() : 'N/A',
                            sponsorLogo: (values[14] && isValidImageUrl(values[14])) ? values[14].trim() : 'N/A'
                        };
                        teams.push(team);
                    } else { console.warn(`Hoppar över lagrad ${index + 2}. Rad: "${values.join(',')}"`); }
                });
                return teams;
            }

            function getTeamLogo(teamName) {
                const team = allTeamsData.find(t => t.teamName === teamName);
                return (team && team.logo && isValidImageUrl(team.logo)) ? team.logo : 'https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo';
            }

            function isValidImageUrl(url) {
                return (url && (url.startsWith('http://') || url.startsWith('https://'))) &&
                    (/\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url));
            }

            function renderGroupStandings(groupName) {
                const groupContainerId = `standings-tab-${groupName.replace(/\s+/g, '-')}`;
                let groupSection = document.getElementById(groupContainerId);

                if (!groupSection) {
                    groupSection = document.createElement('div');
                    groupSection.id = groupContainerId;
                    groupSection.className = 'tab-content table-container';
                    standingsTabsContentDiv.appendChild(groupSection);
                }

                const teamsInGroup = allStandingsData.filter(team => team.group === groupName);
                teamsInGroup.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });

                groupSection.innerHTML = `
                    <h3 class="group-heading">Grupp ${groupName}</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th></th><th>Lag</th><th title="Matcher">M</th><th title="Vinster">V</th><th title="Oavgjorda">O</th><th title="Förluster">F</th>
                                    <th title="Gjorda Mål">GM</th><th title="Insläppta Mål">IM</th><th title="Målskillnad">MS</th><th title="Poäng">P</th><th title="Nästa">Nästa</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${teamsInGroup.map(team => `
                                    <tr>
                                        <td >
                                            <img src="${getTeamLogo(team.teamName)}" alt="${team.teamName} Logo" class="team-logo-small" onerror="this.onerror=null; this.src='https://placehold.co/100x100/aabbcc/ffffff?text=Lag+Logo';">
                                        </td><td>${team.teamName}</td>
                                        <td>${team.matchesPlayed}</td><td>${team.wins}</td><td>${team.draws}</td><td>${team.losses}</td>
                                        <td>${team.goalsFor}</td><td>${team.goalsAgainst}</td><td>${team.goalDifference}</td><td class="points-cell">${team.points}</td><td>${team.nextMatch || 'N/A'}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                console.log(`Standings rendered for group: ${groupName}`);
            }

            function renderTournamentBracket() {
                const bracketContainerId = 'standings-tab-Slutspelsträdet';
                let bracketSection = document.getElementById(bracketContainerId);
                if (!bracketSection) {
                    bracketSection = document.createElement('div');
                    bracketSection.id = bracketContainerId;
                    bracketSection.className = 'tab-content tournament-bracket';
                    standingsTabsContentDiv.appendChild(bracketSection);
                }
                const groupWinners = {}; const groupRunnersUp = {};
                const groupedByGroup = allStandingsData.reduce((acc, team) => {
                    const group = team.group || 'Okänd Grupp'; if (!acc[group]) { acc[group] = []; }
                    acc[group].push(team); return acc;
                }, {});
                Object.keys(groupedByGroup).sort().forEach(groupName => {
                    const teamsInGroup = groupedByGroup[groupName];
                    teamsInGroup.sort((a, b) => (b.points - a.points) || (b.goalDifference - a.goalDifference) || (b.goalsFor - a.goalsFor));
                    if (teamsInGroup.length > 0) groupWinners[groupName] = teamsInGroup[0];
                    if (teamsInGroup.length > 1) groupRunnersUp[groupName] = teamsInGroup[1];
                });
                const qfMatches = [
                    { id: 'QF1', team1: groupWinners['A']?.teamName || 'Vinnare A', team2: groupRunnersUp['B']?.teamName || 'Tvåa B', result: '? - ?' },
                    { id: 'QF2', team1: groupWinners['B']?.teamName || 'Vinnare B', team2: groupRunnersUp['A']?.teamName || 'Tvåa A', result: '? - ?' },
                    { id: 'QF3', team1: groupWinners['C']?.teamName || 'Vinnare C', team2: groupRunnersUp['D']?.teamName || 'Tvåa D', result: '? - ?' },
                    { id: 'QF4', team1: groupWinners['D']?.teamName || 'Vinnare D', team2: groupRunnersUp['C']?.teamName || 'Tvåa C', result: '? - ?' }
                ];
                bracketSection.innerHTML = `
                    <h3 class="group-heading">Slutspelsträdet</h3>
                    <div class="bracket-stages">
                        <div class="bracket-stage"><h4 class="text-xl font-bold text-gray-700 mb-4">Kvartsfinaler</h4>${qfMatches.map(m => `<div class="match-card"><span class="team-name">${m.team1}</span><span class="vs-separator">vs</span><span class="team-name">${m.team2}</span><span class="score">${m.result}</span></div>`).join('')}</div>
                        <div class="bracket-stage"><h4 class="text-xl font-bold text-gray-700 mb-4">Semifinaler</h4><div class="match-card"><span class="team-name">Vinnare QF1</span><span class="vs-separator">vs</span><span class="team-name">Vinnare QF2</span><span class="score">? - ?</span></div><div class="match-card"><span class="team-name">Vinnare QF3</span><span class="vs-separator">vs</span><span class="team-name">Vinnare QF4</span><span class="score">? - ?</span></div></div>
                        <div class="bracket-stage"><h4 class="text-xl font-bold text-gray-700 mb-4">Final</h4><div class="match-card"><span class="team-name">Vinnare SF1</span><span class="vs-separator">vs</span><span class="team-name">Vinnare SF2</span><span class="score">? - ?</span></div><div class="winner-display">Vinnare: <br>[Mästare]</div></div>
                    </div>`;
                console.log('Tournament bracket rendered.');
            }

            function showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                if (activeTab) activeTab.classList.add('active');
                const activeButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
                if (activeButton) activeButton.classList.add('active');
                console.log(`Tab "${tabId}" active.`);
            }

            function renderGroupTabButtons() {
                groupTabButtonsDiv.innerHTML = '';
                const uniqueGroups = new Set(allStandingsData.map(team => team.group).filter(g => g && g !== 'N/A'));
                availableGroups = Array.from(uniqueGroups).sort();
                availableGroups.forEach(group => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-button'; btn.textContent = group;
                    btn.setAttribute('data-tab-id', `standings-tab-${group.replace(/\s+/g, '-')}`);
                    btn.addEventListener('click', () => { renderGroupStandings(group); showTab(`standings-tab-${group.replace(/\s+/g, '-')}`); });
                    groupTabButtonsDiv.appendChild(btn);
                });
                const bracketBtn = document.createElement('button');
                bracketBtn.className = 'tab-button'; bracketBtn.textContent = 'Slutspelsträdet';
                bracketBtn.setAttribute('data-tab-id', 'standings-tab-Slutspelsträdet');
                bracketBtn.addEventListener('click', () => { renderTournamentBracket(); showTab('standings-tab-Slutspelsträdet'); });
                groupTabButtonsDiv.appendChild(bracketBtn);
                if (availableGroups.length > 0) { renderGroupStandings(availableGroups[0]); showTab(`standings-tab-${availableGroups[0].replace(/\s+/g, '-')}`); }
                else { if (bracketBtn) { renderTournamentBracket(); showTab('standings-tab-Slutspelsträdet'); } else { standingsTabsContentDiv.innerHTML = `<div class="text-center text-gray-500 p-8">Inga grupper.</div>`; } }
                console.log('Group tab buttons rendered.');
            }

            function renderQualifiedTeams() {
                qualifiedTeamsListDiv.innerHTML = '';
                if (allStandingsData.length === 0) { qualifiedTeamsListDiv.innerHTML = `<div class="text-center text-gray-500 p-4">Ingen data.</div>`; return; }
                const grouped = allStandingsData.reduce((acc, team) => {
                    const group = team.group || 'Okänd'; if (!acc[group]) { acc[group] = []; }
                    acc[group].push(team); return acc;
                }, {});
                let qualified = [];
                Object.keys(grouped).sort().forEach(groupName => {
                    const teams = grouped[groupName];
                    teams.sort((a, b) => (b.points - a.points) || (b.goalDifference - a.goalDifference) || (b.goalsFor - a.goalsFor));
                    qualified.push(...teams.slice(0, 2));
                });
                if (qualified.length === 0) { qualifiedTeamsListDiv.innerHTML = `<div class="text-center text-gray-500 p-4">Inga lag kvalificerade.</div>`; return; }
                qualifiedTeamsListDiv.innerHTML = `<div class="qualified-teams-grid">${qualified.map(t => `<div class="qualified-team-card">${t.teamName} (${t.group})</div>`).join('')}</div>`;
                console.log(`Rendered ${qualified.length} qualified teams.`);
            }

            function renderMatchResults() {
                matchResultsListDiv.innerHTML = '';
                if (allGamesData.length === 0) { matchResultsListDiv.innerHTML = `<div class="text-center text-gray-500 p-4">Inga resultat.</div>`; return; }
                const completed = allGamesData.filter(g => g.matchStatus === 'Slutrapporterad');
                completed.sort((a, b) => (a.time.replace(':', '')) - (b.time.replace(':', '')));
                // If teams in match results also use logo + name and need ellipsis, you'd wrap team1 and team2 in spans too.
                // For simplicity, current rendering just uses the name.
                matchResultsListDiv.innerHTML = `
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="results-table">
                            <thead><tr><th>#</th><th>Tid</th><th>Hemma</th><th>Borta</th><th>Resultat</th><th>Anm.</th></tr></thead>
                            <tbody>${completed.map(g => `<tr><td>${g.matchId}</td><td>${g.time}</td><td>${g.team1}</td><td>${g.team2}</td><td class="font-bold">${g.result}</td><td>${g.matchStatus !== 'N/A' ? g.matchStatus : ''}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>`;
                console.log('Match results rendered.');
            };

            async function initializeTablesPage() {
                qualifiedTeamsListDiv.innerHTML = `<div class="text-center text-gray-500 p-4">Laddar...</div>`;
                matchResultsListDiv.innerHTML = `<div class="text-center text-gray-500 p-4">Laddar...</div>`;
                groupTabButtonsDiv.innerHTML = '';

                const [standingsCsv, scheduleCsv, playerStatsCsv, teamsCsv] = await Promise.all([
                    fetchCsvData(standingsCsvUrl, standingsTabsContentDiv, "Tabeller"),
                    fetchCsvData(groupScheduleCsvUrl, matchResultsListDiv, "Resultat"),
                    fetchCsvData(teamsCsvUrl, standingsTabsContentDiv, "Laginfo")
                ]);
                allStandingsData = standingsCsv ? parseStandingsCsv(standingsCsv) : [];
                allGamesData = scheduleCsv ? parseGroupScheduleCsv(scheduleCsv) : [];
                allTeamsData = teamsCsv ? parseTeamsCsv(teamsCsv) : [];

                renderQualifiedTeams(); renderGroupTabButtons(); renderMatchResults();
                console.log('Tables page init.');
                if (!allStandingsData.length && !allGamesData.length) {
                    console.error("All data sources empty/failed.");
                    standingsTabsContentDiv.innerHTML = `<div class="text-center text-red-600 font-bold p-8">Kunde inte ladda data.</div>`;
                    qualifiedTeamsListDiv.innerHTML = ''; matchResultsListDiv.innerHTML = ''; groupTabButtonsDiv.innerHTML = '';
                }
            }
            initializeTablesPage();
        });
    </script>
</body>

</html>